<html><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" /><title>Using NixOps to deploy to my Raspberry Pi</title><meta name="description" content="steenuil's blog" /><meta name="generator" content="generator.rkt" /><meta name="referrer" content="strict-origin" /><link rel="stylesheet" href="/assets/style.css" type="text/css" /><link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS feed" /><link rel="alternate" href="/feed.xml" type="application/atom+xml" title="Atom feed" /><link rel="apple-touch-icon-precomposed" href="/assets/icon/favicon-152.png" /><meta name="og:type" content="website" /><meta name="og:title" content="Using NixOps to deploy to my Raspberry Pi" /><meta name="og:description" content="steenuil's blog" /><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@steinuil" /><meta name="twitter:creator" content="@steinuil" /><meta name="twitter:dnt" content="on" /></head><body id="blog-post-page"><div class="body-container"><header><nav><ul><li><a href="/molten-matter/">Molten Matter</a></li><li><a href="/">About</a></li><li><a href="/legal/">Legal</a></li></ul></nav></header><main><header><h1 class="post-title">Using NixOps to deploy to my Raspberry Pi</h1> <time datetime="2021-11-11">2021/11/11</time></header><div class="text"><p>TL;DR: if you have an underpowered machine or two in your house or a small server that you&rsquo;re already managing using NixOS, and you find that running <code>nixos-rebuild</code> on it takes too long, you can easily keep your current configuration untouched and let a more beefy machine build it. Jump to the end of this post for a sample NixOps specification and instructions on how to use it.</p><p>Also, NixOps apparently has some <a href="https://news.ycombinator.com/item?id=20324608">issues</a> involving local state that make it hard to share a deployment with other machines. I just read about a tool called <a href="https://github.com/DBCDK/morph">morph</a> that is almost a drop-in replacement for NixOps and doesn&rsquo;t share these issues. Sadly it is 3AM here and this here setup works well enough for me so I really can&rsquo;t be bothered to check it out right now, but maybe at some point I will and maybe you might want to do it upfront. <a href="https://christine.website/blog/morph-setup-2021-04-25">This</a> is a good post about it.</p></div><hr /><div class="text"><p>I have a Raspberry Pi 3B+ sitting next to my router. I use it to host a couple things to my local network. You might remember it from <a href="https://sgt.hootr.club/molten-matter/nix-distributed-builds/">a previous post</a>, in which I talked about my experience with NixOS&rsquo; distributed builds.</p><p>It&rsquo;s a relatively slow machine and you really don&rsquo;t want to build things directly on it, so at the time I reached for distributed builds to make the experience of rebuilding my configuration a little less painful. That worked out alright, but we can do better.</p><p>While distributed builds <em>do</em> make executing a <code>nixos-rebuild</code> much faster, the Nix expression describing the whole system is still evaluated on the Pi itself, which in the best case results in a virtually nonfunctional system for a couple minutes, and in the worst a slow death as swap fills out. I usually pull the plug when that happens because I can&rsquo;t stand watching the poor thing suffer like that.</p><p>But! There is a fourth solution to this issue that I failed to consider on the previous post though: NixOps! The <a href="https://releases.nixos.org/nixops/latest/manual/manual.html#chap-introduction">NixOps user manual</a> describes it as:</p></div><blockquote class="text"><p>[&hellip;] a tool for deploying NixOS machines in a network or cloud.</p></blockquote><div class="text"><p>This description initially put me off from using it. It makes it sound like something you&rsquo;d only use when you have a bunch of servers, and that just using it for managing one machine would be overkill. It also makes it sound like there&rsquo;s a big learning curve, I mean there&rsquo;s a big one page html manual about it and ain&rsquo;t nobody got the time to read <em>all that</em>. Figuring out Nix already took me long enough.</p><p>And surely I couldn&rsquo;t just <code>import</code> the configuration I was using for the Pi and expect it to work with NixOps, right? I&rsquo;d seen a couple posts about NixOps but they usually involved creating a new server with a new configuration that I didn&rsquo;t really care about, so maybe I&rsquo;d have to make some changes.</p><p>&hellip;Or <em>would I?</em></p><p>This might be a gross oversimplification, but all NixOps does is evaluate a system configuration on your machine, build it, copy the results on one or more target machines and make them switch to that configuration.</p><p>In other words, it&rsquo;s like it runs <code>nixos-rebuild</code> using the Pi&rsquo;s <code>/etc/nixos/configuration.nix</code> but on another computer, and all the Pi has to do is download the results of the rebuild and run it. In other words, does <em>exactly</em> what I needed.</p></div><hr /><div class="text"><p>I was initially worried that I&rsquo;d have to make some changes to the Pi&rsquo;s system configuration to deploy it with NixOps, but all I had to do was write a nix expression telling NixOps where to deploy the configuration and some details about the machine architecture, as described in the <a href="https://releases.nixos.org/nixops/latest/manual/manual.html#sec-deploying-to-physical-nixos">user manual</a>.</p><p>If you&rsquo;re following this at home, make sure to include <em>all</em> your configuration files when you import your existing one, including the <code>hardware-configuration.nix</code> file!</p></div><pre class="brush: nix"><code>{
  network.description = "Raspberry Pi";
  
  pi3 = { config, pkgs, lib, ... }: {
    deployment.targetHost = "192.168.1.x";
    
    nixpkgs.localSystem = {
      system = "aarch64-linux";
      config = "aarch64-unknown-linux-gnu";
    };
    
    imports = [
      ./pi-configuration.nix
    ];
  };
}</code></pre><div class="text"><p>To build an arm64 configuration on an x86_64 system you have to enable arm64 emulation, but I already had that set up from when I was using it distributed builds, I think I got it <a href="https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_QEMU">from here</a>. In any case, this is all you need to add to your <em>build machine</em>&rsquo;s configuration.</p></div><pre class="brush: nix"><code>{
  boot.binfmt.emulatedSystems = [ "aarch64-linux" ];
}</code></pre><div class="text"><p>Then you have to allow your build machine to log into the target machine via SSH as root, install the <code>nixops</code> command and it&rsquo;s just a couple of <code>nixops</code> commands to create the deployment and send it to the Pi.</p></div><pre class="brush: shell"><code>$ nixops create ./rpi.nix -d rpi
$ nixops deploy -d rpi</code></pre><div class="text"><p>These commands will create a new deployment called <code>rpi</code> using the specification file above and deploy it. Not that hard after all!</p></div><hr /><div class="text"><p>Summing up, NixOS is really nice and you, hypothetical reader who isn&rsquo;t using it, should try it. <a href="https://christine.website/talks/nixos-pain-2021-11-10">All issues with documentation and tooling notwithstanding</a>. Here&rsquo;s a couple things that are tangentially related to this post.</p></div><ul><li>Thanks to <a href="https://christine.website/">@cadey</a> and probably a couple others I forget for posting about Nix stuff on Lobsters a lot and getting me to try NixOps out.</li><li><a href="https://kirarin.hootr.club/git/steinuil/nixos-config">This is my NixOS configuration</a> if you <em>really</em> want to look at it. The Gitea server it&rsquo;s hosted on is defined in one of the configurations in there. Very meta. Maybe one day I&rsquo;ll switch it to NixOps.</li><li>When I wrote &ldquo;It&rsquo;s a slow machine&rdquo;, it reminded me of the similar line from Penny Lane by The Beatles and the song started playing in my head and it wouldn&rsquo;t stop. Sadly I couldn&rsquo;t think of a way to work it into the post.</li></ul><div class="text"><p>Good night.</p></div></main><footer>made with <a href="https://racket-lang.org/">racket</a> :: <a href="/rss.xml">rss</a> :: <a href="/feed.xml">atom</a></footer></div></body></html>
<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>A data-fetching component in React</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=/rss.xml>rss</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>A data-fetching component in React</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2019-05-10>2019-05-10</time> tagged <a class=tag href=https://sgt.hootr.club/tags/react/>#react</a></header><div class=content><p>Remember last year's <a href="https://www.youtube.com/watch?v=6g3g0Q_XVb4" rel="nofollow noreferrer external" class=external-link>talk</a> about Suspense by Dan Abramov? I was still mostly learning React when that was uploaded to youtube, and seeing him talk about just this issue and presenting this magic API that seemed to solve it without much effort got me really hooked. But then <a rel="nofollow noreferrer external" class=external-link href=https://reactjs.org/docs/code-splitting.html#suspense>Suspense</a> actually comes out and (even an year later) it's just about code splitting. What gives?<p>Fast forward one year, I was refactoring parts of a smallish React app and taking the opportunity to learn hooks, and I noticed I had a lot of components that shared roughly this structure (plus some unrelated UI state sprinkled in for good measure):<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>class</span><span style=color:#8fbcbb> CookieCutter</span><span style=color:#81a1c1> extends</span><span style=color:#8fbcbb> React</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb;font-weight:700>Component</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>  state</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    hasLoaded</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    data</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> null</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  componentDidMount</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    this</span><span style=color:#eceff4>.</span><span>props</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>fetchData</span><span>()</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>then</span><span>(</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      this</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>setState</span><span>(</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>        hasLoaded</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        data</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  render</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    const</span><span style=color:#eceff4> {</span><span> hasLoaded</span><span style=color:#eceff4>,</span><span> data</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> = this</span><span style=color:#eceff4>.</span><span>state</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span> hasLoaded</span><span style=color:#81a1c1> ?</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;div>{</span><span>data</span><span style=color:#81a1c1>}&lt;/div></span></span>
<span class=giallo-l><span>    )</span><span style=color:#81a1c1> :</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;div></span><span>Loading...</span><span style=color:#81a1c1>&lt;/div></span></span>
<span class=giallo-l><span>    )</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>And since I had just spent all day decomposing old monstrous class components and otherwise wasting time polishing parts of the app like an art project, I started thinking about how I could extract this pattern so it would look like the vague memory I had of Suspense. For reference, this (part of) Suspense's API:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>&lt;</span><span style=color:#8fbcbb>Suspense fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading...</span><span style=color:#81a1c1>&lt;/div>}></span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;</span><span style=color:#8fbcbb>NewComfort</span><span style=color:#81a1c1> /></span></span>
<span class=giallo-l><span style=color:#81a1c1>&lt;/</span><span style=color:#8fbcbb>Suspense</span><span style=color:#81a1c1>></span></span></code></pre><p>Something kind of bothers me about this API: where's the data? How does <code>Suspense</code> know that whatever data <code>NewComfort</code> needs has finished loading? It looks like the data flows downwards from <code>NewComfort</code>, but also upwards towards <code>Suspense</code>? I guess I'm just not used to this stuff, but I thought it'd be better to be a bit more explicit, even if it increased verbosity. I'm also not a huge fan of higher-order components, so instead I decided to rely on the good old trick of <a rel="nofollow noreferrer external" class=external-link href=https://reactjs.org/docs/render-props.html>render props</a>.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>&lt;</span><span style=color:#8fbcbb>LazyLoaded</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  provider</span><span style=color:#81a1c1>={</span><span>fetchData</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading...</span><span style=color:#81a1c1>&lt;/div>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#81a1c1>  {</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;</span><span style=color:#8fbcbb>ChocolateMatter data</span><span style=color:#81a1c1>={</span><span>data</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>  )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>&lt;/</span><span style=color:#8fbcbb>LazyLoaded</span><span style=color:#81a1c1>></span></span></code></pre><p><code>LazyLoaded</code> is probably not a very good name, but I decided to go with that. I was still on the hooks hype train so I went out of my way to implement it using hooks:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>interface</span><span style=color:#8fbcbb> Props</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>  provider</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Promise</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  fallback</span><span style=color:#81a1c1>?:</span><span style=color:#8fbcbb> JSX</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Element</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  children</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> (</span><span>data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> JSX</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Element</span><span style=color:#81a1c1> |</span><span style=color:#8fbcbb> null</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>export function</span><span style=color:#88c0d0> LazyLoaded</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>({</span></span>
<span class=giallo-l><span>  provider</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  fallback</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  children</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Props</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span style=color:#eceff4> [</span><span>data</span><span style=color:#eceff4>,</span><span> setData</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span><span> React</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>useState</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1> |</span><span style=color:#8fbcbb> null</span><span style=color:#eceff4>></span><span>(</span><span style=color:#81a1c1>null</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  React</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>useLayoutEffect</span><span>(</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    setData</span><span>(</span><span style=color:#81a1c1>null</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    provider</span><span>()</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>then</span><span>(</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>      setData</span><span>(data)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  },</span><span> [provider])</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> data</span><span style=color:#81a1c1> ?</span><span style=color:#88c0d0> children</span><span>(data)</span><span style=color:#81a1c1> :</span><span> fallback</span><span style=color:#81a1c1> || null;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>And this worked well enough. At first I implemented it using <code>useEffect</code>, but I noticed that <code>useLayoutEffect</code> would actually skip the split-second load that occurred when the <code>provider</code> resolved immediately if the data was already in the cache.<p>But there's a big issue with this implementation. Do you see it? I didn't until I actually tested the component on the real page. Consider this:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Page</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>VELOCITY</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> |</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>DESIGN</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> |</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>COMFORT</span><span style=color:#eceff4>'</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span style=color:#88c0d0> Main</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ({</span><span> cache</span><span style=color:#eceff4> })</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span style=color:#eceff4> [</span><span>page</span><span style=color:#eceff4>,</span><span> setPage</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span><span> React</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>useState</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Page</span><span style=color:#eceff4>></span><span>(</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>VELOCITY</span><span style=color:#eceff4>'</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;div></span></span>
<span class=giallo-l><span style=color:#81a1c1>      {</span><span>page</span><span style=color:#81a1c1> ===</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>VELOCITY</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> ?</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &lt;</span><span style=color:#8fbcbb>LazyLoaded</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          provider</span><span style=color:#81a1c1>={</span><span>cache</span><span style=color:#eceff4>.</span><span>getTekka</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading tekka...</span><span style=color:#81a1c1>&lt;/div>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ></span></span>
<span class=giallo-l><span style=color:#81a1c1>          {</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>            &lt;</span><span style=color:#8fbcbb>Velocity data</span><span style=color:#81a1c1>={</span><span>data</span><span style=color:#81a1c1>}</span><span style=color:#8fbcbb> setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>          )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &lt;/</span><span style=color:#8fbcbb>LazyLoaded</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>      )</span><span style=color:#81a1c1> :</span><span> page</span><span style=color:#81a1c1> ===</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>DESIGN</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> ?</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &lt;</span><span style=color:#8fbcbb>LazyLoaded</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          provider</span><span style=color:#81a1c1>={</span><span>cache</span><span style=color:#eceff4>.</span><span>getDsco</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading dsco...</span><span style=color:#81a1c1>&lt;/div>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ></span></span>
<span class=giallo-l><span style=color:#81a1c1>          {</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>            &lt;</span><span style=color:#8fbcbb>Design data</span><span style=color:#81a1c1>={</span><span>data</span><span style=color:#81a1c1>}</span><span style=color:#8fbcbb> setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>          )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &lt;/</span><span style=color:#8fbcbb>LazyLoaded</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>      )</span><span style=color:#81a1c1> :</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &lt;</span><span style=color:#8fbcbb>Comfort setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>      )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;/div></span></span>
<span class=giallo-l><span>  )</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><p>We land on<code>'VELOCITY'</code> and switch to '<code>COMFORT'</code> and then to <code>'DESIGN'</code> and everything is good. But then from <code>'DESIGN'</code> we switch the page back to <code>'VELOCITY'</code> and everything breaks. What just happened?<p>To understand this, you should know a bit about what React calls <a rel="nofollow noreferrer external" class=external-link href=https://reactjs.org/docs/reconciliation.html>reconciliation</a>. To ensure that the whole page isn't unmounted and remounted every time something changes, React will look at the component tree and do some diffing to make sure that only what actually needs to be updated will be.<p>In particular, React will look at the "type" of component, and if it remains the same between two updates it will avoid unmounting and remounting it. In this case this is pretty bad news, because when we switch between the two pages above that have a LazyLoaded component at the same level of the render tree, <code>LazyLoaded</code> will not <em>not</em> get unmounted. In the first paint we end up with an invalid state in which the <code>children</code> function is the new one from <code>'VELOCITY'</code>, but the <code>data</code> is the old one we fetched in <code>'DESIGN'</code>.<p>So how do we fix it? The first and dumbest thing that came into mind was make sure that <code>LazyLoaded</code> is unmounted whenever we change the page. React provides a default prop on all components that just about does this this called <code>key</code>.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span>page</span><span style=color:#81a1c1> ===</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>VELOCITY</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> ?</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;</span><span style=color:#8fbcbb>LazyLoaded</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    key</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>VELOCITY</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    provider</span><span style=color:#81a1c1>={</span><span>cache</span><span style=color:#eceff4>.</span><span>getTekka</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading tekka...</span><span style=color:#81a1c1>&lt;/div>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>  ></span></span>
<span class=giallo-l><span style=color:#81a1c1>    {</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;</span><span style=color:#8fbcbb>Velocity data</span><span style=color:#81a1c1>={</span><span>data</span><span style=color:#81a1c1>}</span><span style=color:#8fbcbb> setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>    )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;/</span><span style=color:#8fbcbb>LazyLoaded</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>)</span><span style=color:#81a1c1> :</span><span> page</span><span style=color:#81a1c1> ===</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>DESIGN</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> ?</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;</span><span style=color:#8fbcbb>LazyLoaded</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    key</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>DESIGN</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    provider</span><span style=color:#81a1c1>={</span><span>cache</span><span style=color:#eceff4>.</span><span>getDsco</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    fallback</span><span style=color:#81a1c1>={&lt;div></span><span>Loading dsco...</span><span style=color:#81a1c1>&lt;/div>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>  ></span></span>
<span class=giallo-l><span style=color:#81a1c1>    {</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;</span><span style=color:#8fbcbb>Design data</span><span style=color:#81a1c1>={</span><span>data</span><span style=color:#81a1c1>}</span><span style=color:#8fbcbb> setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>    )</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;/</span><span style=color:#8fbcbb>LazyLoaded</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>)</span><span style=color:#81a1c1> :</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;</span><span style=color:#8fbcbb>Comfort setPage</span><span style=color:#81a1c1>={</span><span>setPage</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span>)</span></span></code></pre><p>By making <code>key</code> required in <code>LazyLoaded</code>'s prop type and adding a threatening doc comment I more or less ensured that users of this component would always add a "reasonably unique" <code>key</code> for the part of the render tree <code>LazyLoaded</code> would be used in. And this worked well and things were good.<p>It's kind of a hack though, so the other day I came back to this component and deleted both the key from the prop type and the threatening comment. Considering the relationship between all the bits that form the state of the component, it becomes obvious that a certain <code>data</code> can only be associated with the <code>children</code> function from the render from which we also got the data's <code>provider</code>. With that in mind, we should modify the component a bit:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>interface</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>  data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  childrenSync</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> (</span><span>data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> JSX</span><span style=color:#eceff4>.</span><span style=color:#8fbcbb>Element</span><span style=color:#81a1c1> |</span><span style=color:#8fbcbb> null</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>export function</span><span style=color:#88c0d0> LazyLoaded</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>({</span></span>
<span class=giallo-l><span>  provider</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  fallback</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  children</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Props</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span style=color:#eceff4> [</span><span>state</span><span style=color:#eceff4>,</span><span> setState</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>    React</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>useState</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>State</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> |</span><span style=color:#8fbcbb> null</span><span style=color:#eceff4>></span><span>(</span><span style=color:#81a1c1>null</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  React</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>useLayoutEffect</span><span>(</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    setState</span><span>(</span><span style=color:#81a1c1>null</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    provider</span><span>()</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>then</span><span>(</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>      setState</span><span>(</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>        data</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        childrenSync</span><span style=color:#eceff4>:</span><span> children</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  },</span><span> [provider])</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> state</span></span>
<span class=giallo-l><span style=color:#81a1c1>    ?</span><span> state</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>childrenSync</span><span>(state</span><span style=color:#eceff4>.</span><span>data)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    :</span><span> fallback</span><span style=color:#81a1c1> || &lt;</span><span style=color:#8fbcbb>Loading</span><span style=color:#81a1c1> />;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Remember that, being a closure, the useLayoutEffect callback will capture the value of <code>children</code> at the time it is defined, so since we defined our types correctly we can be sure that the value returned from the <code>provider</code> will always match the one expected from the <code>children</code>.<p>And now everything is good again. (The error handling and cancellation in this component are left as an exercise to the reader.)<p>I really like this pattern, but I haven't found anything similar to it online when I searched. Maybe I'm just looking in the wrong places? Or maybe other people that came up with this thought it was too simple to warrant writing about it? Nevertheless, I thought it was worth sharing because it's nice and presented a problem with a non-obvious solution, unless you're familiar with some of React's internal workings. Maybe somebody will get a kick out of this.</div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
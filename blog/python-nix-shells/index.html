<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>Simple Python devshells with Nix and direnv</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>Simple Python devshells with Nix and direnv</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2024-06-08>2024-06-08</time> tagged <a class=tag href=https://sgt.hootr.club/tags/python/>#python</a> <a class=tag href=https://sgt.hootr.club/tags/nix/>#nix</a></header><div class=content><p>In my last post, I mentioned I'm currently working at a Python shop. I'm also a huge fan of Nix, and I believe that a day may come when we can get rid of the messy deployment setup we use now and replace it with Nix, but it is not this day. Today I'm just gonna talk about how I stealthily manage my development environments for the Python projects at work with Nix and direnv, and how you could easily do the same.<h2 id=who-is-this-for>Who is this for?</h2><p>You're running NixOS or nix-darwin or home-manager on your computer of choice or maybe you're just trying Nix out, and you just want to get things done at your job.<p>You don't particularly care about building a reproducible derivation or an image that you can deploy with Nix.<p>You don't want to spend too much time figuring out why psycopg or some other Python library you don't want to pick a fight with is not building in your current checkout of nixpkgs.<p>You don't want to install multiple versions of Python on your machine or mess with the tooling that should take care of that for you.<p>You want to keep things clean.<h2 id=what-do-we-want>What do we want?</h2><p>Since this is a work project, let's talk requirements!<ul><li><p>We shouldn't make any changes to the repositories; we don't want to go around dropping files in every team's repos if they don't want to buy into the tooling.</p><li><p>We don't have to go all-in on Nix. Debugging a failing build of a Python package for a repo we don't touch all that often sucks and it adds too much overhead.</p><li><p>Related to the previous point, the setup should be very similar to the one your team members are using.</p></ul><p>In short: don't rock the boat. There's a time and a place for introducing tooling, and it is not now. We just want a working setup that succeeds in providing a Python development environment, without littering our global environment.<h2 id=the-flake>The flake</h2><p>The flake where I keep my dev environments looks kind of like this:<pre class=language-nix data-lang=nix style=color:#d8dee9;background-color:#2e3440><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#8fbcbb>inputs </span><span style=color:#81a1c1>= </span><span>{
</span><span>    </span><span style=color:#8fbcbb>nixpkgs</span><span>.</span><span style=color:#8fbcbb>url </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"github:NixOS/nixpkgs"</span><span style=color:#eceff4>;
</span><span>    </span><span style=color:#8fbcbb>flake-utils</span><span>.</span><span style=color:#8fbcbb>url </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"github:numtide/flake-utils"</span><span style=color:#eceff4>;
</span><span>  }</span><span style=color:#eceff4>;
</span><span>
</span><span>  </span><span style=color:#8fbcbb>outputs </span><span style=color:#81a1c1>= </span><span>{ self</span><span style=color:#81a1c1>, </span><span>nixpkgs</span><span style=color:#81a1c1>, </span><span>flake-utils }:
</span><span>  	flake-utils</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>eachDefaultSystem (system:
</span><span>      </span><span style=color:#81a1c1>let
</span><span>        </span><span style=color:#8fbcbb>pkgs </span><span style=color:#81a1c1>= </span><span style=color:#88c0d0>import </span><span>nixpkgs {
</span><span>          </span><span style=color:#81a1c1>inherit </span><span style=color:#8fbcbb>system</span><span style=color:#eceff4>;
</span><span>        }</span><span style=color:#eceff4>;
</span><span>
</span><span>        </span><span style=color:#8fbcbb>mkPythonShell </span><span style=color:#81a1c1>= </span><span>python:
</span><span>          pkgs</span><span style=color:#81a1c1>.</span><span>mkShell {
</span><span>            </span><span style=color:#8fbcbb>name </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"python-</span><span style=color:#a3be8c;font-style:italic>${</span><span style=color:#d8dee9;font-style:italic>python</span><span style=color:#81a1c1;font-style:italic>.</span><span style=color:#d8dee9;font-style:italic>version</span><span style=color:#a3be8c;font-style:italic>}</span><span style=color:#a3be8c>"</span><span style=color:#eceff4>;
</span><span>            </span><span style=color:#8fbcbb>buildInputs </span><span style=color:#81a1c1>= </span><span>[
</span><span>              pkgs</span><span style=color:#81a1c1>.</span><span>pyright
</span><span>              pkgs</span><span style=color:#81a1c1>.</span><span>ruff
</span><span>              pkgs</span><span style=color:#81a1c1>.</span><span>poetry
</span><span>              (python</span><span style=color:#81a1c1>.</span><span>withPackages (ps: [
</span><span>                ps</span><span style=color:#81a1c1>.</span><span>black
</span><span>                ps</span><span style=color:#81a1c1>.</span><span>flake8
</span><span>              ]))
</span><span>            ]</span><span style=color:#eceff4>;
</span><span>          }</span><span style=color:#eceff4>;
</span><span>      </span><span style=color:#81a1c1>in
</span><span>      {
</span><span>        </span><span style=color:#8fbcbb>devShells </span><span style=color:#81a1c1>= </span><span>{
</span><span>          </span><span style=color:#8fbcbb>python39 </span><span style=color:#81a1c1>= </span><span>mkPythonshell pkgs</span><span style=color:#81a1c1>.</span><span>python39</span><span style=color:#eceff4>;
</span><span>          </span><span style=color:#8fbcbb>python310 </span><span style=color:#81a1c1>= </span><span>mkPythonShell pkgs</span><span style=color:#81a1c1>.</span><span>python310</span><span style=color:#eceff4>;
</span><span>          </span><span style=color:#8fbcbb>python311 </span><span style=color:#81a1c1>= </span><span>mkPythonShell pkgs</span><span style=color:#81a1c1>.</span><span>python311</span><span style=color:#eceff4>;
</span><span>          </span><span style=color:#8fbcbb>python312 </span><span style=color:#81a1c1>= </span><span>mkPythonShell pkgs</span><span style=color:#81a1c1>.</span><span>python312</span><span style=color:#eceff4>;
</span><span>        }</span><span style=color:#eceff4>;
</span><span>      }
</span><span>    )</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>I keep one devShell for each version of Python, and only install tools that are required for Python development but are not specified in the project dependencies so they don't litter my <code>$PATH</code> when I'm not using them. I prefer to keep this package set small so that it breaks less often.<p>To use it, you're gonna have to create a new git repository, dump the code above in a <code>flake.nix</code>, and then run <code>nix flake lock</code>. You can also try running one of the shells with <code>nix develop .#python312</code> to make sure that everything is working correctly.<p>This flake is freestanding and lives outside of any existing repos, and if you manage to convert some coworkers to Nix it can be pushed to the company's git forge of choice.<h2 id=the-envrc>The .envrc</h2><p><a rel="nofollow noreferrer" class=external-link href=https://direnv.net/>direnv</a> is a wonderful tool and if you're not using it yet, you should check it out. It installs a hook inside your shell that runs when you change directories, and when it detects that an <code>.envrc</code> file is present in the current directory or further up the tree, it runs the commands specified in that <code>.envrc</code> file and updates the env variables accordingly. This means that you can set env variables, add executables to your <code>$PATH</code> and, crucially, set your Python venv automatically.<p>This <code>.envrc</code> is a simple shell script that is executed with some predefined utility commands (the <a rel="nofollow noreferrer" class=external-link href=https://direnv.net/man/direnv-stdlib.1.html>stdlib</a>). These include loading <code>.env</code> files with <code>dotenv</code> and automatically setting the correct interpreter version and installing dependencies for several languages. We don't need most of that though, because the Nix dev environment manages the Python version for us.<p>If you're using <code>home-manager</code>, the installation is as easy as:<pre class=language-nix data-lang=nix style=color:#d8dee9;background-color:#2e3440><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#8fbcbb>programs</span><span>.</span><span style=color:#8fbcbb>direnv </span><span style=color:#81a1c1>= </span><span>{
</span><span>    </span><span style=color:#8fbcbb>enable </span><span style=color:#81a1c1>= true</span><span style=color:#eceff4>;
</span><span>    </span><span style=color:#8fbcbb>nix-direnv</span><span>.</span><span style=color:#8fbcbb>enable </span><span style=color:#81a1c1>= true</span><span style=color:#eceff4>;
</span><span>  }</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p><code>nix-direnv</code> is absolutely required when you're working with flakes. Without it, it may take several seconds to <code>cd</code> into the project directory. With <code>nix-direnv</code>, loading previously cached flakes will take less than a second.<p>To drop into one of the Python shells we created in our flakes, create an <code>.envrc</code> file in the root of a repository containing this:<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>use</span><span> flake ../path/to/flake#python310
</span></code></pre><p>(The path/to/flake can be <a rel="nofollow noreferrer" class=external-link href=https://nix.dev/manual/nix/2.22/command-ref/new-cli/nix3-flake.html#examples>anything that is accepted as a flake URL</a>: a relative path from your current directory, a git repository on github or your employer's git forge, or a URL that points to a tarball.)<p>Then close the file, run <code>direnv allow</code>, and you should see Nix preparing a dev environment containing the Python 3.11 interpreter and all the tools we specified in the flake. This might take a while the first time you do it, but after the initial setup it'll be instantaneous. Try it out!<pre style=color:#d8dee9;background-color:#2e3440><code><span>$ cd project
</span><span>direnv: loading project/.envrc
</span><span>direnv: using flake ../path/to/flake#python310
</span><span>direnv: nix-direnv: using cached dev shell
</span><span>direnv: export +AR +AS +CONFIG_SHELL ...
</span><span>$ black --version
</span><span>black, 24.4.2 (compiled: yes)
</span><span>Python (CPython) 3.10.13
</span><span>$ python -V
</span><span>Python 3.10.13
</span><span>$ cd ..
</span><span>direnv: unloading
</span><span>$ black --version
</span><span>bash: black: command not found
</span><span>$ python -V
</span><span>Python 3.9.6
</span></code></pre><p>The <code>.envrc</code> file should live at the root of your project, but if you don't want to check it into git or add it into <code>.gitignore</code> you can sneakily add an ignore for it inside your project's <code>.git/info/exclude</code>.<pre class=language-gitignore data-lang=gitignore style=color:#d8dee9;background-color:#2e3440><code class=language-gitignore data-lang=gitignore><span style=color:#81a1c1>.</span><span>direnv</span><span style=color:#81a1c1>/
</span><span style=color:#81a1c1>.</span><span>envrc
</span></code></pre><p>Now if you run <code>git status</code>, you won't see any added files!<h2 id=the-venv>The venv</h2><p>For reasons I won't go into here, we're still using <code>pip</code> and good old <code>requirements.txt</code> files to specify dependencies rather than <code>poetry</code> or any of the fancy new Python tooling. To simplify this dev environment setup and keep it close to our coworkers', we're gonna use normal Python tooling to set up the virtual env and install dependencies.<ul><li><p>First of all, create the venv.</p> <pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>python</span><span> -m venv venv
</span></code></pre><li><p>Then add these lines to your <code>.envrc</code> to make <code>direnv</code> load the venv. (I added the <code>VIRTUAL_ENV_DISABLE_PROMPT</code> bit because it messes up my Starship prompt, but you may want to keep it.)</p> <pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#81a1c1>export </span><span>VIRTUAL_ENV_DISABLE_PROMPT</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>1
</span><span style=color:#88c0d0>source</span><span> venv/bin/activate
</span></code></pre><li><p>Enter the venv by allowing the changes you made to your <code>.envrc</code>.</p> <pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>direnv</span><span> allow
</span></code></pre><li><p>Now that you're inside the venv, upgrade <code>pip</code> and <code>setuptools</code> and install <code>wheel</code>. (Imma keep it real with you: this is just cargo culting. I don't actually know how much of this is needed. Feel free to @ me for this one.)</p> <pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>pip3</span><span> install --upgrade pip setuptools
</span><span style=color:#88c0d0>pip</span><span> install wheel
</span></code></pre><li><p>Let's get installing!</p> <pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>pip</span><span> install -r requirements.txt
</span></code></pre></ul><h2 id=the-end>The end</h2><p>Repeat this for every Python repository you might have at your company. That's it! You can start working on the actual tasks in your sprint now.</div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>NixOps is easier than I thought</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=/rss.xml>rss</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>NixOps is easier than I thought</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2021-11-11>2021-11-11</time> tagged <a class=tag href=https://sgt.hootr.club/tags/nix/>#nix</a></header><div class=content><p>TL;DR: if you have an underpowered machine or two in your house or a small server that you're already managing using NixOS, and you find that running <code>nixos-rebuild</code> on it takes too long, you can easily keep your current configuration untouched and let a more beefy machine build it. Jump to the end of this post for a sample NixOps specification and instructions on how to use it.<p>Also, NixOps apparently has some <a href="https://news.ycombinator.com/item?id=20324608" rel="nofollow noreferrer external" class=external-link>issues</a> involving local state that make it hard to share a deployment with other machines. I just read about a tool called <a rel="nofollow noreferrer external" class=external-link href=https://github.com/DBCDK/morph>morph</a> that is almost a drop-in replacement for NixOps and doesn't share these issues. Sadly it is 3AM here and this here setup works well enough for me so I really can't be bothered to check it out right now, but maybe at some point I will and maybe you might want to do it upfront. <a rel="nofollow noreferrer external" class=external-link href=https://christine.website/blog/morph-setup-2021-04-25>This</a> is a good post about it.<hr><p>I have a Raspberry Pi 3B+ sitting next to my router. I use it to host a couple things to my local network. Here's a photo.<p><img alt="The Pi 3 in its natural habitat." src=https://sgt.hootr.club/blog/nixops-on-the-pi/pi.gif><p>That hunk of metal I just got also acts as a heatsink and it brought down the CPU temperature by 10°C. That's pretty good!<p>You might remember it from <a rel="nofollow noreferrer external" class=external-link href=https://sgt.hootr.club/molten-matter/nix-distributed-builds/>a previous post</a>, in which I talked about my experience with NixOS' distributed builds. It's a slow machine and you really don't want to build things directly on it, so at the time I reached for distributed builds to make the experience of rebuilding my configuration a little less painful. That worked out alright, but we can do better.<p>While distributed builds <em>do</em> make executing a <code>nixos-rebuild</code> much faster, the Nix expression describing the whole system is still evaluated on the Pi itself, which in the best case results in a virtually nonfunctional system for a couple minutes, and in the worst a slow death as swap fills out. I usually pull the plug when that happens because I can't stand watching the poor thing suffer.<p>But! There is a fourth solution to this issue that I failed to consider on the previous post though: NixOps! The <a rel="nofollow noreferrer external" class=external-link href=https://releases.nixos.org/nixops/latest/manual/manual.html#chap-introduction>NixOps user manual</a> describes it as:<blockquote><p>[...] a tool for deploying NixOS machines in a network or cloud.</blockquote><p>This description initially put me off from using it. It makes it sound like something you'd only use when you have a bunch of servers, and that just using it for managing one machine would be overkill. It also makes it sound like there's a big learning curve, I mean there's a big one page html manual about it and ain't nobody got the time to read all that. Figuring out Nix already took me long enough.<p>And surely I couldn't just <code>import</code> the configuration I was using for the Pi and expect it to work with NixOps, right? I'd seen a couple posts about NixOps but they usually involved creating a new server with a new configuration that I didn't really care about, so maybe I'd have to make some changes.<p>...Or <em>would I?</em><p>This might be a gross oversimplification, but all NixOps does is evaluate a system configuration on your machine, build it, copy the results on one or more target machines and make them switch to that configuration.<p>In other words, it's like it runs <code>nixos-rebuild</code> using the Pi's <code>/etc/nixos/configuration.nix</code> but on another computer, and all the Pi has to do is download the results of the rebuild and run it. In yet other words, it does <em>exactly</em> what I needed.<hr><p>I was initially worried that I'd have to make some changes to the Pi's system configuration to deploy it with NixOps, but all I had to do was write a nix expression telling NixOps where to deploy the configuration and some details about the machine architecture, as described in the <a rel="nofollow noreferrer external" class=external-link href=https://releases.nixos.org/nixops/latest/manual/manual.html#sec-deploying-to-physical-nixos>user manual</a>.<p>If you're following this at home, make sure to include <em>all</em> your configuration files when you import your existing one, including the <code>hardware-configuration.nix</code> file!<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  network</span><span>.</span><span style=color:#8fbcbb>description</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Raspberry Pi</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pi3</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> config</span><span style=color:#81a1c1>,</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> lib</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }: {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    deployment</span><span>.</span><span style=color:#8fbcbb>targetHost</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>192.168.1.x</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    nixpkgs</span><span>.</span><span style=color:#8fbcbb>localSystem</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      config</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-unknown-linux-gnu</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    imports</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span></span>
<span class=giallo-l><span style=color:#a3be8c>      ./pi-configuration.nix</span></span>
<span class=giallo-l><span style=color:#eceff4>    ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>To build an arm64 configuration on an x86_64 system you have to enable arm64 emulation, but I already had that set up from when I was using it for distributed builds, I think I got it <a rel="nofollow noreferrer external" class=external-link href=https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_QEMU>from here</a>. In any case, this is all you need to add to your <em>build machine</em>'s configuration.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  boot</span><span>.</span><span style=color:#8fbcbb>binfmt</span><span>.</span><span style=color:#8fbcbb>emulatedSystems</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Then you have to allow your build machine to log into the target machine via SSH as root, install the <code>nixops</code> command and it's just a couple of <code>nixops</code> commands to create the deployment and send it to the Pi.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nixops create ./rpi.nix -d rpi</span></span>
<span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nixops deploy -d rpi</span></span></code></pre><p>These commands will create a new deployment called <code>rpi</code> using the specification file above and deploy it. Not that hard after all!<hr><p>Summing up, NixOS is really nice and you, hypothetical reader who isn't using it, should try it. <a rel="nofollow noreferrer external" class=external-link href=https://christine.website/talks/nixos-pain-2021-11-10>All issues with documentation and tooling notwithstanding</a>. Here's a couple things that are tangentially related to this post.<ul><li>Thanks to <a rel="nofollow noreferrer external" class=external-link href=https://christine.website/>@cadey</a> and probably a couple others I forget for posting about Nix stuff on Lobsters a lot, those posts got me to try NixOps out.<li><a rel="nofollow noreferrer external" class=external-link href=https://kirarin.hootr.club/git/steinuil/nixos-config>This is my NixOS configuration</a> if you <em>really</em> want to look at it. The Gitea server it's hosted on is defined in one of the configurations in there. Very meta. Maybe one day I'll switch it to NixOps.<li>When I wrote "It's a slow machine", it reminded me of the similar line from Penny Lane by The Beatles and the song started playing in my head and it wouldn't stop. Sadly I couldn't think of a way to work it into the post.</ul><p>Good night.</div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
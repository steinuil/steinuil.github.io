<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>Overthinking cash in TypeScript</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>Overthinking cash in TypeScript</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2018-11-11>2018-11-11</time> tagged <a class=tag href=https://sgt.hootr.club/tags/typescript/>#typescript</a> <a class=tag href=https://sgt.hootr.club/tags/type-level-programming/>#type-level-programming</a></header><div class=content><p><img alt="cicada shells on a tree near a beach in Marina di Cecina, Italy" src=https://sgt.hootr.club/blog/overthinking-cash/shells.jpg><p>Part of my current project at work deals with monetary values in the form of cash, making change, and displaying the bills and coins on the screen.<p>Since I recently started adding types to certain parts of the codebase with TypeScript, I thought it'd be fun to see how elaborately I could model the types of the values and of the functions using TypeScript's more advanced features, and while I was at it, how easy it would be to parametrize the types based on the currency you're dealing with.<p>First of all, I'm gonna define what I mean by "cash". Since I need to show the bills and coins on the screen at scale, I need to know their color and their dimensions, and here's the issue: coins only need a width, but banknotes also need a height, so I can't use the same type for both.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>interface Coin</span><span>&lt;</span><span style=color:#8fbcbb>Amount</span><span>> {
</span><span>  amount</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Amount</span><span style=color:#eceff4>;
</span><span>  color</span><span style=color:#81a1c1>: string</span><span style=color:#eceff4>;
</span><span>  width</span><span style=color:#81a1c1>: number</span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>interface Banknote</span><span>&lt;</span><span style=color:#8fbcbb>Amount</span><span>> {
</span><span>  amount</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Amount</span><span style=color:#eceff4>;
</span><span>  color</span><span style=color:#81a1c1>: string</span><span style=color:#eceff4>;
</span><span>  width</span><span style=color:#81a1c1>: number</span><span style=color:#eceff4>;
</span><span>  height</span><span style=color:#81a1c1>: number</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>Now I have to store these values somewhere. Using two objects, one for the coins and one for the banknotes, would be the simplest solution, but it would complicate things at the call site when we don't know whether the amount is a coin or a banknote.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>const </span><span style=color:#88c0d0;font-weight:700>cashInfo </span><span style=color:#81a1c1>= </span><span>(amount</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>CashAmount</span><span>)</span><span style=color:#81a1c1>: ??? => </span><span>(
</span><span>  amount </span><span style=color:#81a1c1>> </span><span style=color:#b48ead>200
</span><span>  </span><span style=color:#81a1c1>? </span><span>banknotesByAmount
</span><span>  </span><span style=color:#81a1c1>: </span><span>coinsByAmount
</span><span>)[amount]</span><span style=color:#eceff4>;
</span></code></pre><p>This is not a very elegant piece of code, and TypeScript doesn't like it much either.<p><img alt="not even Sayaka likes it" src=https://sgt.hootr.club/blog/overthinking-cash/cash-money-of-you.png><h2 id=dependent-kinda-types-to-the-rescue>Dependent (kinda) types to the rescue!</h2><p>TypeScript 2.8 introduced <a rel="nofollow noreferrer" class=external-link href=https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-8.html>conditional types</a> which (as I understand it) are a light form of dependent types, like the ones in Coq or Idris. You can use them to implement basic arithmetic with peano numbers, which is cool as hell, but unfortunately not very useful in real code (at least at the moment).<p>Now I can define a type which returns either <code>Coin</code> or <code>Banknote</code> depending on the type of its argument:<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type ByAmount</span><span>&lt;</span><span style=color:#8fbcbb>CoinAmt</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>BanknoteAmt</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#8fbcbb>Amt </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>CoinAmt </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>BanknoteAmt
</span><span>> </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Amt </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>CoinAmt     </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>Coin</span><span>&lt;</span><span style=color:#8fbcbb>Amt</span><span>>
</span><span>  </span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Amt </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>BanknoteAmt </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>Banknote</span><span>&lt;</span><span style=color:#8fbcbb>Amt</span><span>>
</span><span>  </span><span style=color:#81a1c1>: never</span><span style=color:#eceff4>;
</span></code></pre><p>Note that I'm still parametrizing over the denomination to make it possible to use different currencies easily, so the signature still looks a bit awful, but it'll only need one type parameter when "instantiated".<p>Defining the type of the object is now a breeze, thanks to mapped types.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type CashMap</span><span>&lt;
</span><span>  </span><span style=color:#8fbcbb>CoinAmt </span><span style=color:#81a1c1>extends number</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#8fbcbb>BanknoteAmt </span><span style=color:#81a1c1>extends number</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#8fbcbb>Amount </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>CoinAmt </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>BanknoteAmt
</span><span>> </span><span style=color:#81a1c1>= </span><span>{
</span><span>  </span><span style=color:#81a1c1>readonly </span><span>[</span><span style=color:#8fbcbb>A </span><span style=color:#81a1c1>in </span><span style=color:#8fbcbb>Amount</span><span>]</span><span style=color:#81a1c1>:
</span><span>    </span><span style=color:#8fbcbb>Readonly</span><span>&lt;</span><span style=color:#8fbcbb>ByAmount</span><span>&lt;</span><span style=color:#8fbcbb>CoinAmt</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>BanknoteAmt</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>A</span><span>>></span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>Now we're ready to instantiate these types with a currency.<h2 id=plugging-in-the-eurodollars>Plugging in the Eurodollars</h2><p>TypeScript doesn't have <a rel="nofollow noreferrer" class=external-link href=https://dev.realworldocaml.org/variants.html#scrollNav-4>polymorphic variants</a>, but it does have <strong>numeric literal types</strong>, which are just as good for our purposes. Let's define the denominations.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type EuroCoinAmt =
</span><span>  </span><span style=color:#b48ead>1 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>2 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>5 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>10 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>20 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>50 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>100 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>200</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type EuroBanknoteAmt =
</span><span>  </span><span style=color:#b48ead>500 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>1000 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>2000 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>5000 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>10000 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>20000 </span><span style=color:#81a1c1>| </span><span style=color:#b48ead>50000</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type EuroAmount =
</span><span>  </span><span style=color:#8fbcbb>EuroCoinAmt </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>EuroBanknoteAmt</span><span style=color:#eceff4>;
</span></code></pre><p>Now I can fill in the maps.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type EuroMap = </span><span style=color:#8fbcbb>CashMap</span><span>&lt;
</span><span>  </span><span style=color:#8fbcbb>EuroCoinAmt</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>EuroBanknoteAmt</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>EuroAmount
</span><span>></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>const </span><span style=color:#d8dee9;font-weight:700>euroByAmount</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>EuroMap </span><span style=color:#81a1c1>= </span><span>{
</span><span>  </span><span style=color:#b48ead>1</span><span style=color:#eceff4>: </span><span>{
</span><span>    amount</span><span style=color:#eceff4>: </span><span style=color:#b48ead>1</span><span style=color:#eceff4>,
</span><span>    color</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'#b87333'</span><span style=color:#eceff4>,
</span><span>    width</span><span style=color:#eceff4>: </span><span style=color:#b48ead>16</span><span style=color:#eceff4>,
</span><span>  }</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#b48ead>2</span><span style=color:#eceff4>: </span><span>{
</span><span>    amount</span><span style=color:#eceff4>: </span><span style=color:#b48ead>2</span><span style=color:#eceff4>,
</span><span>    color</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'#b87333'</span><span style=color:#eceff4>,
</span><span>    width</span><span style=color:#eceff4>: </span><span style=color:#b48ead>18.5</span><span style=color:#eceff4>,
</span><span>  }</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#616e88>/* ... */
</span><span>  </span><span style=color:#b48ead>500</span><span style=color:#eceff4>: </span><span>{
</span><span>    amount</span><span style=color:#eceff4>: </span><span style=color:#b48ead>500</span><span style=color:#eceff4>,
</span><span>    color</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>'grey'</span><span style=color:#eceff4>,
</span><span>    width</span><span style=color:#eceff4>: </span><span style=color:#b48ead>120</span><span style=color:#eceff4>,
</span><span>    height</span><span style=color:#eceff4>: </span><span style=color:#b48ead>62</span><span style=color:#eceff4>,
</span><span>  }</span><span style=color:#eceff4>,
</span><span>  </span><span style=color:#616e88>/* ... */
</span><span>}</span><span style=color:#eceff4>;
</span></code></pre><p>Since this is all static data, the compiler is able to verify that:<ul><li>I didn't forget nor invent any coin or banknote<li>objects indexed by a <code>BanknoteAmount</code> effectively have a <code>height</code> field, and that those indexed by a <code>CoinAmount</code> don't<li>the indexing key matches the <code>amount</code> field</ul><p>When I try indexing the object, the compiler will infer the correct type based on the type of its argument, and complain when trying to index a value that does not exist (though the error message for that is a bit confusing).<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span>euroByAmount[</span><span style=color:#b48ead>500</span><span>]</span><span style=color:#eceff4>; </span><span style=color:#616e88>// Readonly&lt;Banknote&lt;500>>
</span><span>euroByAmount[</span><span style=color:#b48ead>2</span><span>]</span><span style=color:#eceff4>;   </span><span style=color:#616e88>// Readonly&lt;Coin&lt;2>>
</span><span>
</span><span style=color:#616e88>// error: Element implicitly has an 'any' type
</span><span style=color:#616e88>// because type 'CashMap&lt;EuroCoinAmt, EuroBanknoteAmt, EuroAmount>'
</span><span style=color:#616e88>// has no index signature.
</span><span>euroByAmount[</span><span style=color:#b48ead>3</span><span>]</span><span style=color:#eceff4>;
</span></code></pre><p>The advantage of keeping the more general types around is that we can now differentiate between functions that work the same regardless of the currency, and functions that might require a different implementation for each currency.<p>In my project I have a function that returns a few reasonable change suggestions given an amount of money, in which the optimal solution is calculated using a simple greedy algorithm. This works for euros, where the greedy algorithm does indeed return an optimal solution, but it might not be a good fit for other currencies with different denominations, so in this particular case it makes sense to use the specific types for euros, rather than the more general ones.<h2 id=conclusions>Conclusions</h2><p>TypeScript has a rather quirky type system with many features that vaguely resemble those found in other languages but not quite, like literal types, and some weird features taken straight from niche almost-research languages, like conditional and mapped types, but somehow they all fit together rather nicely to model the sort of JS code you'd write normally.<p>This is TypeScript's biggest strength, in my opinion: I barely had to change my code when adding types to this module, and it would still make sense if you took the types out, even if I had written this in TS to begin with.<h2 id=further-reading>Further reading</h2><ul><li><a rel="nofollow noreferrer" class=external-link href=https://frontstuff.io/how-to-handle-monetary-values-in-javascript>How to Handle Monetary Values in JavaScript</a><li><a rel="nofollow noreferrer" class=external-link href=https://ren.zone/articles/safe-money>Money in the type system where it belongs</a><li><a rel="nofollow noreferrer" class=external-link href=https://github.com/sarahdayan/dinero.js>Dinero.js</a> - An immutable library to create, calculate and format money.</ul></div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
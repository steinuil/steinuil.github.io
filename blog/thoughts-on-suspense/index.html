<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>Thoughts on Suspense for data fetching</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=/rss.xml>rss</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>Thoughts on Suspense for data fetching</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2019-10-30>2019-10-30</time> tagged <a class=tag href=https://sgt.hootr.club/tags/react/>#react</a> <a class=tag href=https://sgt.hootr.club/tags/musings/>#musings</a></header><div class=content><p>React's <a rel="nofollow noreferrer external" class=external-link href=https://reactjs.org/docs/concurrent-mode-intro.html>Concurrent Mode</a> has finally landed in React's experimental builds, and it just so happens that I have to start writing this new app at work to be used internally, so what better way to get my hands dirty with this new shiny stuff!<p><a href=/molten-matter/data-fetching-react/>In another post</a> I expressed some disconcert at what little I remembered of Suspense's API (kinda missed that .read() thingy in the fetch request), and that... is still there after seeing the full API. I think you'll see what I mean.<h2 id=exceptions-for-control-flow>Exceptions for control flow</h2><p>I happen to have here a sort of minimal working example of "Suspense for data fetching".<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>const</span><span style=color:#88c0d0> Hello</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ({</span><span> resource</span><span style=color:#eceff4> })</span><span style=color:#81a1c1> =></span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>  &lt;span></span><span>Hello </span><span style=color:#81a1c1>{</span><span style=color:#88c0d0>resource</span><span>()</span><span style=color:#81a1c1>}&lt;/span></span></span>
<span class=giallo-l><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span style=color:#88c0d0> SuspendTest</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span> resource</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> suspendPromise</span><span>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    await</span><span style=color:#88c0d0> sleep</span><span>(</span><span style=color:#b48ead>3000</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>from inside a shell</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;</span><span style=color:#8fbcbb>Suspense fallback</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>loading...</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;</span><span style=color:#8fbcbb>Hello resource</span><span style=color:#81a1c1>={</span><span>resource</span><span style=color:#81a1c1>} /></span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;/</span><span style=color:#8fbcbb>Suspense</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>  )</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><ul><li>This will display "loading..." for 3 seconds and then show "Hello from inside a shell"<li><code>sleep</code> is <code>(ms) => new Promise((resolve) => setTimeout(resolve, ms))</code><li>We'll call "resource" the thing that provides our <code>Hello</code> component with the data it needs to render</ul><p>The resource is clearly a promise but you don't have to await it; you just call it as if you already had the data inside it. How the hell does this work? The title of this section kinda spoiled it, but here it is anyway:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=typescript><span class=giallo-l><span style=color:#81a1c1>export function</span><span style=color:#88c0d0> suspendPromise</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span style=color:#88c0d0>thunk</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Promise</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span><span> state</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> status</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>PENDING</span><span style=color:#eceff4>" }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span> pendingPromise</span><span style=color:#81a1c1> =</span><span> (</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    try</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>      state</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> status</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>SUCCESS</span><span style=color:#eceff4>",</span><span> data</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> await</span><span style=color:#88c0d0> thunk</span><span>()</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> catch</span><span> (e)</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>      state</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> status</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>ERROR</span><span style=color:#eceff4>",</span><span> error</span><span style=color:#eceff4>:</span><span> e</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span>)()</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    switch</span><span> (state</span><span style=color:#eceff4>.</span><span>status)</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      case</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>PENDING</span><span style=color:#eceff4>":</span></span>
<span class=giallo-l><span style=color:#81a1c1>        throw</span><span> pendingPromise</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      case</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ERROR</span><span style=color:#eceff4>":</span></span>
<span class=giallo-l><span style=color:#81a1c1>        throw</span><span> state</span><span style=color:#eceff4>.</span><span>error</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      case</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>SUCCESS</span><span style=color:#eceff4>":</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span> state</span><span style=color:#eceff4>.</span><span>data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>It fires the promise and then returns a function that will fetch the data, if it's available. And if it's not, it just <em>throws the promise</em>. That's it, that's the magic. <code>Suspense</code> then will act like an <a rel="nofollow noreferrer external" class=external-link href=https://reactjs.org/docs/error-boundaries.html>error boundary</a> and catch the promise and then do whatever it is that it does to promises. Presumably await them and then retry with the rendering roughly when they're done.<p>This is the part where I pretend to know what algebraic effects are and say, gosh, this looks a lot like algebraic effects.<p>I grew to like fetching in useEffect, but I won't deny it's always looked a bit awkward, so I'm glad this deprecates it. I'm also glad this makes the API synchronous, because it means that error boundaries are finally useful. To be frank, I haven't implemented error handling in the data-fetching component I use in another app because if the request returns an error it can only mean the server is down, and that's a scenario I don't really want to entertain. That and the API wouldn't make it very pleasant to deal with errors.<p>I don't know what to make of <code>useTransition</code> yet, but I think I'll write another post about it when I figure it out. This is just a braindump of what I gathered so far.<h2 id=another-thought>Another thought</h2><p>One thing I've learnt is that you <em>have</em> to read from the resource in a different component than the one you use <code>Suspense</code> in, so you can't inline Hello into SuspendTest.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=tsx><span class=giallo-l><span style=color:#81a1c1>const</span><span style=color:#88c0d0> SuspendTest</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  const</span><span> resource</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> suspendPromise</span><span>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> ()</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    await</span><span style=color:#88c0d0> sleep</span><span>(</span><span style=color:#b48ead>3000</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>from inside a shell</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> (</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;</span><span style=color:#8fbcbb>Suspense fallback</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>loading...</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#81a1c1>      &lt;span></span><span>Hello </span><span style=color:#81a1c1>{</span><span style=color:#88c0d0>resource</span><span>()</span><span style=color:#81a1c1>}&lt;/span></span><span> // Bad!</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;/</span><span style=color:#8fbcbb>Suspense</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span>  )</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><p>And I'm wondering how they will enforce this. Probably just with some error messages and a slap on the wrist like "the rules of hooks".<hr><p>The full code for this post is available on <a rel="nofollow noreferrer external" class=external-link href=https://codesandbox.io/s/modest-rosalind-xdpgx>CodeSandbox</a>.</div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
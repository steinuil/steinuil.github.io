<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>The journey of packaging a .NET app on Nix</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=/rss.xml>rss</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>The journey of packaging a .NET app on Nix</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2020-04-01>2020-04-01</time> tagged <a class=tag href=https://sgt.hootr.club/tags/nix/>#nix</a> <a class=tag href=https://sgt.hootr.club/tags/fsharp/>#fsharp</a></header><div class=content><p>Me and a few friends have a Discord server where we all gather once a week (or even twice lately, due to recent events) to watch a movie together. It's been going on for about three and a half years and we thought it'd be about time to make a bot that handles voting and backlog and times for us, so we started writing one, in F#.<p>My Raspberry Pi running NixOS is on 24/7, so I thought I could run the bot from there and learn something about packaging on Nix while doing so.<p><strong>Disclaimer</strong>: I have very little experience with packaging in Nix. If you spot any mistakes please tell me and I'll correct them!<hr><p>First I thought I could cross-compile the bot and then just run the compiled version, so I wouldn't have to bother with packaging the dependencies. Cross-compiling a .NET Core program using the <code>dotnet</code> cli is very easy, you just have to specify the <a rel="nofollow noreferrer external" class=external-link href=https://docs.microsoft.com/en-us/dotnet/core/rid-catalog>runtime identifier</a> and use the <code>--self-contained</code> flag so the target machine doesn't need to have the .NET runtime installed to run it.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> dotnet publish --self-contained -r linux-arm64 -c Release</span></span></code></pre><p>I sent the output to the pi and inspected it with <code>ldd</code>. Running binaries on NixOS is <a rel="nofollow noreferrer external" class=external-link href=https://nixos.wiki/wiki/Packaging/Binaries>not as easy</a> as on other Linux distros, because the paths to the dynamically loaded libraries are not predictable, so those hardcoded in the source are usually wrong.<p>I tried to patch the binary with <code>patchelf</code> but didn't have much luck; even when I did manage to make it run it just printed this message:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>No usable version of libssl was found</span></span></code></pre><p>And then dumped core. Later I learned that I could probably have avoided almost everything below this point, but at the moment I didn't so I decided to just do it the hard way.<h2 id=the-first-derivation>The first derivation</h2><p>I cloned the repository on the Pi and quickly discovered that the <code>dotnet-sdk</code> package did not support arm64. This was easy enough to fix; I downloaded the .nix file and modified the URL and the hash to point to the <code>linux-arm64</code> version of the SDK. (I promise I'll upstream support for arm64 eventually, but for the moment it's just on my machine.)<p>It worked well enough; I could build the bot. So I tried to make a simple derivation for it.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> stdenv</span><span style=color:#81a1c1>,</span><span> libunwind</span><span style=color:#81a1c1>,</span><span> openssl</span><span style=color:#81a1c1>,</span><span> icu</span></span>
<span class=giallo-l><span style=color:#81a1c1>,</span><span> libuuid</span><span style=color:#81a1c1>,</span><span> zlib</span><span style=color:#81a1c1>,</span><span> curl</span><span style=color:#81a1c1>,</span><span> callPackage</span></span>
<span class=giallo-l><span style=color:#81a1c1>,</span><span> dotnet-sdk</span><span style=color:#eceff4> }:</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpath</span><span style=color:#81a1c1> =</span><span> stdenv</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>makeLibraryPath</span><span style=color:#eceff4> [</span></span>
<span class=giallo-l><span>    stdenv</span><span style=color:#81a1c1>.</span><span>cc</span><span style=color:#81a1c1>.</span><span>cc libunwind libuuid icu</span></span>
<span class=giallo-l><span>    openssl zlib curl</span></span>
<span class=giallo-l><span style=color:#eceff4>  ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  dynamicLinker</span><span style=color:#81a1c1> =</span><span> stdenv</span><span style=color:#81a1c1>.</span><span>cc</span><span style=color:#81a1c1>.</span><span>bintools</span><span style=color:#81a1c1>.</span><span>dynamicLinker</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>in</span><span> stdenv</span><span style=color:#81a1c1>.</span><span>mkDerivation</span><span style=color:#81a1c1> rec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pname</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>kino-bot</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  version</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>2020-03-29</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  src</span><span style=color:#81a1c1> = builtins.</span><span>fetchGit</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>pname</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>-</span><span style=color:#81a1c1>${</span><span>version</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>-git</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    url</span><span style=color:#81a1c1> =</span><span style=color:#a3be8c> https://github.com/steinuil/KinoBot</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ref</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>master</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    rev</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>275ae0447ab1ab21cba76bb673f00559ed5d9251</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  buildInputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> dotnet-sdk</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  buildPhase</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ''</span></span>
<span class=giallo-l><span style=color:#a3be8c>    export DOTNET_CLI_TELEMETRY_OPTOUT=1</span></span>
<span class=giallo-l><span style=color:#a3be8c>    export HOME="$(mktemp -d)"</span></span>
<span class=giallo-l><span style=color:#a3be8c>    dotnet publish --nologo \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      -r linux-arm64 --self-contained \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      -c Release -o out</span></span>
<span class=giallo-l><span style=color:#eceff4>  ''</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  installPhase</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ''</span></span>
<span class=giallo-l><span style=color:#a3be8c>    runHook preInstall</span></span>
<span class=giallo-l><span style=color:#a3be8c>    mkdir -p $out/bin</span></span>
<span class=giallo-l><span style=color:#a3be8c>    cp -r ./out/* $out</span></span>
<span class=giallo-l><span style=color:#a3be8c>    ln -s $out/KinoBot $out/bin/KinoBot</span></span>
<span class=giallo-l><span style=color:#a3be8c>    runHook postInstall</span></span>
<span class=giallo-l><span style=color:#eceff4>  ''</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  dontPatchELF</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  postFixup</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ''</span></span>
<span class=giallo-l><span style=color:#a3be8c>    patchelf --set-interpreter "</span><span style=color:#81a1c1>${</span><span>dynamicLinker</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>" \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      --set-rpath '$ORIGIN:</span><span style=color:#81a1c1>${</span><span>rpath</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>' $out/KinoBot</span></span>
<span class=giallo-l><span style=color:#a3be8c>    find $out -type f -name "*.so" -exec \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      patchelf --set-rpath '$ORIGIN:</span><span style=color:#81a1c1>${</span><span>rpath</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>' {} ';'    </span></span>
<span class=giallo-l><span style=color:#eceff4>  ''</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  meta</span><span style=color:#81a1c1> = with</span><span> stdenv</span><span style=color:#81a1c1>.</span><span>lib;</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    homepage</span><span style=color:#81a1c1> =</span><span style=color:#a3be8c> https://github.com/steinuil/KinoBot</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    platforms</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    license</span><span style=color:#81a1c1> =</span><span> licenses</span><span style=color:#81a1c1>.</span><span>isc</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>(I took inspiration from <a rel="nofollow noreferrer external" class=external-link href=https://gist.github.com/jb55/b8b49893e18b61fb8c3ea3c924358278>this gist</a> and a few other derivations I found to come up with this.)<p>So I tried to run it:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>$ nix repl '&lt;nixpkgs>'</span></span>
<span class=giallo-l><span>Welcome to Nix version 2.3.3. Type :? for help.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>Loading '&lt;nixpkgs>'...</span></span>
<span class=giallo-l><span>Added 10863 variables.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>nix-repl> kino-bot = callPackage (import ./kino-bot.nix) {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>nix-repl> :b kino-bot</span></span></code></pre><p>But it got stuck on the <code>dotnet restore</code> step of the build. I discovered that external connections are not allowed during the build step of a Nix derivation, so I had to fetch the dependencies <em>through Nix</em>.<h2 id=packaging-the-dependencies-and-a-digression-on-base32-hashes>Packaging the dependencies and a digression on base32 hashes</h2><p>It turns out the <code>dotnet</code> command takes a <code>--source</code> argument which lets you specify a folder containing the NuGet packages. I started by copying the <a rel="nofollow noreferrer external" class=external-link href=https://gist.github.com/jb55/b8b49893e18b61fb8c3ea3c924358278>aforementioned gist</a>, which got the list of all direct and transitive dependencies from the <code>obj/project.assets.json</code> file. I didn't want to install Node though, so I rewrote the script in F#.<p>There's a problem with the script though: the dependencies file specifies a base64-encoded sha512 hash which doesn't correspond to the hash of the zip file, and probably not to the <a rel="nofollow noreferrer external" class=external-link href=https://www.mankier.com/1/nix-hash>Nix serialization of the path</a> either.<p>The hashes that Nix uses are also not at all like the ones you see in the wild; they use too many characters for hex, but also too few for base64. In fact Nix uses its own version of base32, more compact than base16 but still only containing ASCII digits and lowercase letters (except e o u t, which were chosen <a rel="nofollow noreferrer external" class=external-link href=https://discourse.nixos.org/t/no-hashes-starting-with-e-t-o-or-u-in-nix-store/4906/7>to reduce the chance of the hash containing swearwords</a>). The implementation is specified in <a rel="nofollow noreferrer external" class=external-link href=https://github.com/NixOS/nix/blob/master/src/libutil/hash.cc#L76>src/libutil/hash.cc</a> and it's very compact and easily ported to other languages. This is my F# implementation:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=fsharp><span class=giallo-l><span style=color:#81a1c1>module</span><span> Base32</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> chars</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>0123456789abcdfghijklmnpqrsvwxyz</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> length size </span><span style=color:#81a1c1>=</span></span>
<span class=giallo-l><span style=color:#81a1c1>    (</span><span>size </span><span style=color:#81a1c1>*</span><span style=color:#b48ead> 8</span><span style=color:#81a1c1> -</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>) /</span><span style=color:#b48ead> 5</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> fromBytes</span><span style=color:#81a1c1> (</span><span>bytes </span><span style=color:#81a1c1>:</span><span> byte</span><span style=color:#81a1c1>[]) =</span></span>
<span class=giallo-l><span style=color:#81a1c1>    seq {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> n </span><span style=color:#81a1c1>=</span><span> length bytes.Length </span><span style=color:#81a1c1>-</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1> downto</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> do</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> b</span><span style=color:#81a1c1> =</span><span> n </span><span style=color:#81a1c1>*</span><span style=color:#b48ead> 5</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> i</span><span style=color:#81a1c1> =</span><span> b </span><span style=color:#81a1c1>/</span><span style=color:#b48ead> 8</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> j</span><span style=color:#81a1c1> =</span><span> b </span><span style=color:#81a1c1>%</span><span style=color:#b48ead> 8</span></span>
<span class=giallo-l><span style=color:#81a1c1>            yield</span><span> int bytes</span><span style=color:#81a1c1>.[</span><span>i</span><span style=color:#81a1c1>] >>></span><span> j </span><span style=color:#81a1c1>||| if</span><span> i </span><span style=color:#81a1c1>>=</span><span> bytes.Length </span><span style=color:#81a1c1>-</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1> then</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> else</span><span> int bytes</span><span style=color:#81a1c1>.[</span><span>i </span><span style=color:#81a1c1>+</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>] &lt;&lt;&lt; (</span><span style=color:#b48ead>8</span><span style=color:#81a1c1> -</span><span> j</span><span style=color:#81a1c1>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    |></span><span> Seq.map </span><span style=color:#81a1c1>(fun</span><span> c </span><span style=color:#81a1c1>-></span><span> chars</span><span style=color:#81a1c1>.[</span><span>c </span><span style=color:#81a1c1>&&&</span><span style=color:#b48ead> 0x1f</span><span style=color:#81a1c1>])</span></span>
<span class=giallo-l><span style=color:#81a1c1>    |></span><span> Seq.toArray</span></span>
<span class=giallo-l><span style=color:#81a1c1>    |></span><span> System.String</span></span></code></pre><p>You don't really have to use base32, as Nix also supports base16-encoded hashes, but I thought it'd be fun to try implementing it on my own.<p>But let's go back to the dependencies. After some head scratching because <code>nix-hash</code> apparently returned a different hash for a dependency downloaded through curl than for one downloaded through <code>nix-prefetch-url</code> I figured I just had to pass the <code>-L</code> flag to curl to follow the redirect, and then the hashes were identical.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nix-prefetch-url https://www.nuget.org/api/v2/package/Argu/6.0.0</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span style=color:#b48ead>0.2</span><span> MiB DL</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#88c0d0>path</span><span style=color:#a3be8c> is</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>/nix/store/rn0qb89ibmn3xv7ay28309r0wj3xaf5q-6.0.0</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>1zybqx0ka89s2cxp7y2bc9bfiy9mm3jn8l3593f58z6nshwh3f2j</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># WRONG</span></span>
<span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> curl -o Argu.6.0.0.zip https://www.nuget.org/api/v2/package/Argu/6.0.0</span></span>
<span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nix-hash --type sha256 --flat --base32 ./Argu.6.0.0.zip</span></span>
<span class=giallo-l><span style=color:#88c0d0>04w8jx2wzss3y2c9bx6dm6lxib03v2jnr89iakcgk93zippfxb0w</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> curl -L -o Argu.6.0.0.zip https://www.nuget.org/api/v2/package/Argu/6.0.0</span></span>
<span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nix-hash --type sha256 --flat --base32 ./Argu.6.0.0.zip</span></span>
<span class=giallo-l><span style=color:#88c0d0>1zybqx0ka89s2cxp7y2bc9bfiy9mm3jn8l3593f58z6nshwh3f2j</span></span></code></pre><p>And there I was with my newly created <a rel="nofollow noreferrer external" class=external-link href=https://discourse.nixos.org/>discourse.nixos.org</a> account ready to send a post demanding explanations. Oh well!<p>I had to also write my own version of <code>fetchNuGet</code> because the default one tried to build the artifacts again for some reason, didn't support sha512, and used mono which I'm not using. I used the same gist as above for inspiration.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> baseName</span><span style=color:#81a1c1>,</span><span> version</span><span style=color:#81a1c1>,</span><span> sha512</span><span style=color:#eceff4> }:</span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span><span style=color:#8fbcbb> nupkgName</span><span style=color:#81a1c1> =</span><span> lib</span><span style=color:#81a1c1>.</span><span>strings</span><span style=color:#81a1c1>.</span><span>toLower</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>baseName</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>.</span><span style=color:#81a1c1>${</span><span>version</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>.nupkg</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>; in</span></span>
<span class=giallo-l><span>  stdenvNoCC</span><span style=color:#81a1c1>.</span><span>mkDerivation</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>baseName</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>-</span><span style=color:#81a1c1>${</span><span>version</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    src</span><span style=color:#81a1c1> =</span><span> fetchurl</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      inherit</span><span style=color:#8fbcbb> sha512</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>https://www.nuget.org/api/v2/package/</span><span style=color:#81a1c1>${</span><span>baseName</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/</span><span style=color:#81a1c1>${</span><span>version</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>baseName</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>.</span><span style=color:#81a1c1>${</span><span>version</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>.zip</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    sourceRoot</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>.</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    buildInputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> unzip</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    dontStrip</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    installPhase</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ''</span></span>
<span class=giallo-l><span style=color:#a3be8c>      mkdir -p $out</span></span>
<span class=giallo-l><span style=color:#a3be8c>      chmod +r *.nuspec</span></span>
<span class=giallo-l><span style=color:#a3be8c>      cp *.nuspec $out</span></span>
<span class=giallo-l><span style=color:#a3be8c>      cp $src $out/</span><span style=color:#81a1c1>${</span><span>nupkgName</span><span style=color:#81a1c1>}</span></span>
<span class=giallo-l><span style=color:#eceff4>    ''</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span></code></pre><p>The <code>nuget2nix</code> script generates a file that looks roughly like this:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span>name</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> rec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  cache</span><span style=color:#81a1c1> =</span><span> linkFarm</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>name</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>-nuget-pkgs</span><span style=color:#eceff4>"</span><span> packages</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  packages</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span style=color:#8fbcbb> name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Argu</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      path</span><span style=color:#81a1c1> =</span><span> fetchNuGet</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>       baseName</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Argu</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>       version</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>6.0.0</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>       sha512</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>1kiqh4zpasydq5vx4wn5mal5v8c2bdalczja5za9phvq8n9c3s453lj5kmrqar1rfp3504kakb5csxflj7dwy2aas04d0jjw9dhm9g2</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>The <code>linkFarm</code> function, which is only documented in a <a rel="nofollow noreferrer external" class=external-link href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/trivial-builders.nix#L303>comment in the source</a> (Nix has a recurring problem with documentation, yes) takes every derivation in its second arguments and links it as a subdirectory into a derivation named after the first, which is exactly what I needed for the <code>--source</code> directory in the restore step of the build.<p>Before going back to the main file, a few protips about the packages, because these things got me stuck for a while:<ul><li>If you source the packages from your <a rel="nofollow noreferrer external" class=external-link href=https://devblogs.microsoft.com/nuget/enable-repeatable-package-restores-using-a-lock-file/>lockfile</a> you will have to set the <code>RuntimeIdentifiers</code> property in your <code>.[cf]sproj</code>, or else you'll be missing some platform-specific ones like <code>runtime.native.System.Security.Cryptography.OpenSsl</code>.<li>Make sure you don't download the same dependency twice, or you'll get an error in the <code>ln</code> phase of the <code>linkFarm</code> derivation saying "Permission denied".<li>There's a few dependencies listed under <code>project.frameworks.&lt;yourTargetFramework>.downloadDependencies</code> in the <code>obj/project.assets.json</code> file that you'll also have to include in the build. These are the ones called like <code>Microsoft.NETCore.App.Runtime.linux-arm64</code> and so on.</ul><h2 id=finally-running-the-bot>Finally running the bot</h2><p>Nothing much has changed in the main derivation. I just added the link farm derivation to the list of dependencies and set it as source in the <code>dotnet publish</code> command.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#81a1c1>let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpath</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>...</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  nugetPkgs</span><span style=color:#81a1c1> =</span><span> callPackage</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>import</span><span style=color:#a3be8c> ./kino-bot-nuget.nix</span><span style=color:#eceff4>) {} "</span><span style=color:#a3be8c>kino-bot</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>in</span><span> stdenv</span><span style=color:#81a1c1>.</span><span>mkDerivation</span><span style=color:#81a1c1> rec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>  # ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  buildInputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> dotnet-sdk nugetPkgs</span><span style=color:#81a1c1>.</span><span>cache</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  buildPhase</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ''</span></span>
<span class=giallo-l><span style=color:#a3be8c>    export DOTNET_CLI_TELEMETRY_OPTOUT=1</span></span>
<span class=giallo-l><span style=color:#a3be8c>    export HOME="$(mktemp -d)"</span></span>
<span class=giallo-l><span style=color:#a3be8c>    dotnet publish --nologo \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      -r linux-arm64 --self-contained \</span></span>
<span class=giallo-l><span style=color:#a3be8c>      --source #{nugetPkgs.cache} -c Release -o out</span></span>
<span class=giallo-l><span style=color:#eceff4>  ''</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>After all this I could finally build the package locally, but when I tried to run it I got the same libssl error as in the beginning. Was this all for naught? (Maybe it was.)<p>Turns out .NET Core <a rel="nofollow noreferrer external" class=external-link href=https://stackoverflow.com/questions/51901359/net-core-2-1-sdk-linux-x64-no-usable-version-of-the-libssl-was-found>only supports version 1.0 of openssl</a>, and the version packaged by Nix is 1.1. This is easily fixed by importing <code>openssl_1_0_2</code> instead of <code>openssl</code>.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=diff><span class=giallo-l><span>   rpath = stdenv.lib.makeLibraryPath [</span></span>
<span class=giallo-l><span>     stdenv.cc.cc libunwind libuuid icu</span></span>
<span class=giallo-l><span style=color:#eceff4>+</span><span style=color:#a3be8c>    openssl_1_0_2 zlib curl</span></span>
<span class=giallo-l><span style=color:#eceff4>-</span><span style=color:#bf616a>    openssl zlib curl</span></span>
<span class=giallo-l><span>   ];</span></span></code></pre><h2 id=adding-the-package-to-your-system>Adding the package to your system</h2><p>Now that I got it running I had to add it to the system, and to do this you need <a rel="nofollow noreferrer external" class=external-link href=https://nixos.wiki/wiki/Overlays>overlays</a>. An overlay is just a function that takes two arguments, named self and super, and returns a set of packages. This is what mine looks like:<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span>self</span><span style=color:#eceff4>:</span><span> super</span><span style=color:#eceff4>: {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  dotnet-sdk</span><span style=color:#81a1c1> =</span><span> super</span><span style=color:#81a1c1>.</span><span>callPackage</span><span style=color:#a3be8c> ./pkgs/dotnet-sdk.nix</span><span style=color:#eceff4> {}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  kino-bot</span><span style=color:#81a1c1> =</span><span> super</span><span style=color:#81a1c1>.</span><span>callPackage</span><span style=color:#a3be8c> ./pkgs/kino-bot.nix</span><span style=color:#eceff4> {}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Then I imported it to the main <code>configuration.nix</code> file. (Note the parenthesis around the import: Nix will throw <a href="https://discourse.nixos.org/t/infinite-recursion-encountered-at-undefined-position/3039/13?u=steinuil" rel="nofollow noreferrer external" class=external-link>a cryptic infinite recursion error</a> with no stack trace if you forget them!)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  nixpkgs</span><span>.</span><span style=color:#8fbcbb>overlays</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ (</span><span style=color:#88c0d0>import</span><span style=color:#a3be8c> ./my-overlay.nix</span><span style=color:#eceff4>) ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  environment</span><span>.</span><span style=color:#8fbcbb>systemPackages</span><span style=color:#81a1c1> = with</span><span> pkgs;</span><span style=color:#eceff4> [</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span>    kino-bot</span></span>
<span class=giallo-l><span style=color:#eceff4>  ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>I also added a systemd service to start it automatically.<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>services</span><span>.</span><span style=color:#8fbcbb>kino-bot</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    enable</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    after</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>network.target</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    wantedBy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>multi-user.target</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    serviceConfig</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Restart</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>on-failure</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      ExecStart</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>pkgs</span><span style=color:#81a1c1>.</span><span>kino-bot</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/bin/KinoBot --token </span><span style=color:#81a1c1>${</span><span>secrets</span><span style=color:#81a1c1>.</span><span>kinoBotToken</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><hr><p>This took me a few days to get working, and I had to rebuild everything dozens of times to get it working. I omitted several dumb mistakes I made and only kept in those that I had the most trouble with because I thought they could help others.<p>Nonetheless, I really like NixOS and I'll definitely be using it more and package more things in the future. It's already my main Linux OS on my (personal) laptop and my Raspberry Pi (I use Windows on my desktop and work laptop, sadly) and this was a good occasion to learn more about how its packages work. I'll probably be migrating my server to it too in the future.<p><a rel="nofollow noreferrer external" class=external-link href=https://gist.github.com/steinuil/11c7565253e4af03658f59c9c331d268>Code for this post here</a>. <em>Note: there's many hacks specific to my use-case left in the code and it's probably not usable as-is.</em><h2 id=further-reading>Further reading</h2><ul><li><a rel="nofollow noreferrer external" class=external-link href=https://nixos.org/nixos/nix-pills/index.html>Nix pills</a><li><a rel="nofollow noreferrer external" class=external-link href=https://nixos.org/nixpkgs/manual/>Nixpkgs manual</a></ul></div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
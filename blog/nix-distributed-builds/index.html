<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>Offloading NixOS builds to a faster machine</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>Offloading NixOS builds to a faster machine</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2021-01-24>2021-01-24</time> tagged <a class=tag href=https://sgt.hootr.club/tags/nix/>#nix</a></header><div class=content><p>I have a Raspberry Pi 3 sitting next to my router, from which I host a couple things to my local network. I installed NixOS on it and I love the experience: it completely removes the absolute nightmare that is configuring a Linux machine, and I find that incredibly liberating.<p>But there's a catch: the Pi is slow and it doesn't have a lot of memory. Just evaluating the configuration with <code>nixos-rebuild</code> takes about a minute even when there haven't been any changes, and compiling anything substantial is usually a recipe for Death By Swap.<p>The other day I tried updating the main <a rel="nofollow noreferrer" class=external-link href=https://nixos.wiki/wiki/Nix_channels>channel</a> (the package repository) and upgrading my packages with <code>nixos-rebuild switch --upgrade</code> and found out that one of the packages I was using wasn't available on the main <a rel="nofollow noreferrer" class=external-link href=https://nixos.wiki/wiki/Binary_Cache>binary cache</a> at <code>cache.nixos.org</code> anymore, so it had to be built locally. The program in question is written in Rust and has a pretty sizeable dependency graph. I left it to build overnight. The morning after it was still stuck on building one of the sub-packages, and I couldn't even open a new ssh connection to the Pi.<p>There's a couple solutions to this:<ul><li>Build the program on another machine and add a new package that just fetches this binary and patches it<li>Setting up a binary cache on another machine<li>Setting up distributed builds</ul><p>The first one is an ugly hack (in Nix terms, at least) and would probably end up being more trouble than it's worth.<p>The second option, setting up another binary cache, is definitely better. The <a rel="nofollow noreferrer" class=external-link href=https://nixos.wiki/wiki/Binary_Cache>wiki page</a> does a good job of explaining how to set up the server, and on the client you just need to add a couple lines to your <code>configuration.nix</code> to enable it:<pre class=language-nix data-lang=nix style=color:#d8dee9;background-color:#2e3440><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#8fbcbb>nix </span><span style=color:#81a1c1>= </span><span>{
</span><span>    </span><span style=color:#8fbcbb>binaryCaches </span><span style=color:#81a1c1>= </span><span>[ </span><span style=color:#a3be8c>"http://&lt;server url>" </span><span>]</span><span style=color:#eceff4>;
</span><span>    </span><span style=color:#8fbcbb>binaryCachePublicKeys </span><span style=color:#81a1c1>= </span><span>[ </span><span style=color:#a3be8c>"&lt;the cache's public key>" </span><span>]</span><span style=color:#eceff4>;
</span><span>  }</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>The downside is that you have to know beforehand which packages you need to build, and not being very well-versed in Nix I couldn't figure out how to build the specific versions I needed.<p>So we're left with the third option, distributed builds. The <a rel="nofollow noreferrer" class=external-link href=https://nixos.wiki/wiki/Distributed_build>wiki page</a> opens with this paragraph:<blockquote><p>Sometimes you want to use a faster machine for building a nix derivation you want to use on a slower one. If you have ssh access to a machine where Nix (not necessarily NixOS) is installed, then you can offload building to this machine.</blockquote><p>Which seems to be exactly what I'm looking for.<p>The wiki mentions a couple options to add in <code>configuration.nix</code> to enable offloading builds to the client. I used these on the Pi:<pre class=language-nix data-lang=nix style=color:#d8dee9;background-color:#2e3440><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#8fbcbb>nix </span><span style=color:#81a1c1>= </span><span>{
</span><span>    </span><span style=color:#8fbcbb>distributedBuilds </span><span style=color:#81a1c1>= true</span><span style=color:#eceff4>;
</span><span>    </span><span style=color:#8fbcbb>buildMachines </span><span style=color:#81a1c1>= </span><span>[
</span><span>      {
</span><span>        </span><span style=color:#8fbcbb>hostName </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>"builder"</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#8fbcbb>systems </span><span style=color:#81a1c1>= </span><span>[ </span><span style=color:#a3be8c>"x86_64-linux" "aarch64-linux" </span><span>]</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#8fbcbb>maxJobs </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>4</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#8fbcbb>speedFactor </span><span style=color:#81a1c1>= </span><span style=color:#b48ead>2</span><span style=color:#eceff4>;
</span><span>        </span><span style=color:#8fbcbb>supportedFeatures </span><span style=color:#81a1c1>= </span><span>[ </span><span style=color:#a3be8c>"nixos-test" "benchmark" "big-parallel" "kvm" </span><span>]</span><span style=color:#eceff4>;
</span><span>      }
</span><span>    ]</span><span style=color:#eceff4>;
</span><span>  }</span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#8fbcbb>programs</span><span>.</span><span style=color:#8fbcbb>ssh</span><span>.</span><span style=color:#8fbcbb>extraConfig </span><span style=color:#81a1c1>= </span><span style=color:#a3be8c>''
</span><span style=color:#a3be8c>    Host builder
</span><span style=color:#a3be8c>      HostName &lt;url of the host>
</span><span style=color:#a3be8c>      Port 2222
</span><span style=color:#a3be8c>      User builder
</span><span style=color:#a3be8c>      IdentitiesOnly yes
</span><span style=color:#a3be8c>      IdentityFile /root/.ssh/id_builder
</span><span style=color:#a3be8c>  ''</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>I created the key in <code>/root/.ssh/id_builder</code> using the options recommended in <a rel="nofollow noreferrer" class=external-link href=https://security.stackexchange.com/a/144044>this Stack Exchange answer</a> (not that it matters since it's all on my local network):<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> ssh-keygen -t ed25519 -a 100 -f /root/.ssh/id_builder
</span></code></pre><p>For the host machine I had to go with emulation, since I don't have another ARM64 machine lying around. My beefy desktop runs Windows so I created a VirtualBox machine with 4 cores, 8GB of memory, and a couple GB of hard drive space to store the build results. Setting up emulation was incredibly easy after finding <a rel="nofollow noreferrer" class=external-link href=https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_QEMU>the NixOS on ARM wiki page</a>, all it takes is one line in the VM's <code>configuration.nix</code>:<pre class=language-nix data-lang=nix style=color:#d8dee9;background-color:#2e3440><code class=language-nix data-lang=nix><span>{
</span><span>  </span><span style=color:#8fbcbb>boot</span><span>.</span><span style=color:#8fbcbb>binfmt</span><span>.</span><span style=color:#8fbcbb>emulatedSystems </span><span style=color:#81a1c1>= </span><span>[ </span><span style=color:#a3be8c>"aarch64-linux" </span><span>]</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>Then I had to activate OpenSSH with <code>services.openssh.enable = true;</code>, add the Pi's public key to <code>/home/builder/.ssh/authorized_keys</code>, forward the SSH port on the VM to 2222, and open that port in the Windows firewall.<p>To test that it's working you can try building a package on the client with the <code>max-jobs</code> option set to 0.<pre class=language-bash data-lang=bash style=color:#d8dee9;background-color:#2e3440><code class=language-bash data-lang=bash><span style=color:#88c0d0>$</span><span> nix-build -j0 --expr </span><span style=color:#a3be8c>'with import &lt;nixpkgs> {}; callPackage ./default.nix {}'
</span></code></pre><p>I'm really surprised by how simple all of that was. Setting up a VM that automatically builds packages for another machine while emulating another architecture sounds like a nightmare, but with NixOS it's a couple lines of configuration.<p>And in case you're wondering, yes, it worked beautifully, and even though the emulation slows things down quite a bit it's still much faster than building things directly on the Pi.</div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>
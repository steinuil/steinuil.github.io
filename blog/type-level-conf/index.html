<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><title>Config constraints in the type system where they belong</title><meta content="steen's online burrow" name=description><meta content=Zola name=generator><meta content=strict-origin name=referrer><link href=https://sgt.hootr.club/assets/style.css rel=stylesheet><link title="RSS feed" href=/rss.xml rel=alternate type=application/rss+xml><link title="Atom feed" href=/atom.xml rel=alternate type=application/atom+xml><link href=/assets/icon/favicon-152.png rel=apple-touch-icon-precomposed><body class=main-parent><div class=main-parent><header class=main><h1 class=header-title><a href=https://sgt.hootr.club>STEENSBURROW</a></h1><nav><ul class=unstyled><li><a class=unstyled href=https://sgt.hootr.club/me/>me</a><li><a class=unstyled href=https://sgt.hootr.club/blog/>posts</a><li><a class=unstyled href=https://sgt.hootr.club/meta/>meta</a></ul></nav></header><main class=main><article><header><h1 class=title>Config constraints in the type system where they belong</h1><p class=subtitle>Published by <a href=/><i>steen</i></a> on <time datetime=2019-09-17>2019-09-17</time> tagged <a class=tag href=https://sgt.hootr.club/tags/typescript/>#typescript</a> <a class=tag href=https://sgt.hootr.club/tags/type-level-programming/>#type-level-programming</a> <a class=tag href=https://sgt.hootr.club/tags/shitpost/>#shitpost</a></header><div class=content><p>Suppose we're maintaining a frontend application. This application has to work across different sites, each identified by a triplet of name, language and country. Let us have a type for that.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>interface Site </span><span>{
</span><span>  name</span><span style=color:#81a1c1>: string</span><span style=color:#eceff4>;
</span><span>  language</span><span style=color:#81a1c1>: string</span><span style=color:#eceff4>;
</span><span>  country</span><span style=color:#81a1c1>: string</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>Our coworker Homer passes by and looks at our code.<p>This is good enough, he might say, and we know he's wrong. We have a list of all the site names and supported locales ready to be used. What the hell is a string?, we ask him. Is the empty string a valid site name? Is "dddsdsddddssddsdsd" a valid language? Is Wales a country? Does the pope shit in the woods?<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type SiteName = </span><span style=color:#a3be8c>"scylla" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Language = </span><span style=color:#a3be8c>"it" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"de" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"el" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Country = </span><span style=color:#a3be8c>"IT" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"CH" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"GR" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"HR"</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>interface Site </span><span>{
</span><span>  name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>;
</span><span>  language</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>;
</span><span>  country</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Country</span><span style=color:#eceff4>;
</span><span>}
</span></code></pre><p>Only there's a catch: not all sites support all locales, and not all locales are valid. In fact we have a list of all the possible permutations of these three parameters. I have it on good authority that people in Italy don't speak Greek, and yet the type of <code>Site</code> says otherwise. How can we sleep at night knowing that one day Homer could just wake up and go add a site with locale <code>el_IT</code>?<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type SiteName = </span><span style=color:#a3be8c>"scylla" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Language = </span><span style=color:#a3be8c>"it" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"de" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"el" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Country = </span><span style=color:#a3be8c>"IT" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"CH" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"GR" </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"HR"</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>interface S</span><span>&lt;</span><span style=color:#8fbcbb>N </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>L </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>C </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Country</span><span>> {
</span><span>  name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>;
</span><span>  language</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>;
</span><span>  country</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>C</span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>type Site =
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"IT"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"el"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"GR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span></code></pre><p>Now we have an issue: if we were to add a new language, say "fr", we'd have to add it in two places, and too much typing is bad for our wrists. Let us reduce the risk of carpal tunnel.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>interface S</span><span>&lt;</span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Country</span><span>> {
</span><span>  name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>;
</span><span>  language</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>;
</span><span>  country</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Country</span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>type Site =
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"IT"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"el"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"GR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"fr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type SiteName = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"name"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Language = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"language"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Country = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"country"</span><span>]</span><span style=color:#eceff4>;
</span></code></pre><p>Much better. Our wrists rejoice.<p>Now suppose we have a feature that we only want to see on scylla, so we only want to handle the locales that are supported on scylla. TS defines a utility types that does just that called <code>Extract</code>, so let us define some utility types for that.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type SitesByName</span><span>&lt;</span><span style=color:#8fbcbb>N </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>SiteName</span><span>> </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Extract</span><span>&lt;</span><span style=color:#8fbcbb>Site</span><span style=color:#eceff4>, </span><span>{ name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>N </span><span>}></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type _1 = </span><span style=color:#8fbcbb>SitesByName</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span>>[</span><span style=color:#a3be8c>"country"</span><span>]</span><span style=color:#eceff4>; </span><span style=color:#616e88>// "IT" | "GR" | "HR"
</span></code></pre><p>We also want to have a string representation of each site, so we can use it as key in an object for features that have a different behavior on each sites. This is a bit boilerplatey, but sadly necessary.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>type SiteString =
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"scylla|it_IT"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"scylla|el_GR"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"scylla|hr_HR"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis|de_CH"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis|fr_CH"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis|it_CH"
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#a3be8c>"charybdis|hr_HR"</span><span style=color:#eceff4>;
</span></code></pre><p>We also need some function to convert a <code>Site</code> to and from a <code>SiteString</code>, but if we were to do it with just these types we'd be losing precious type information in the process! We surely don't want that. We need some sort of conversion table.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>interface SiteOfString </span><span>{
</span><span>  </span><span style=color:#a3be8c>"scylla|it_IT"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"IT"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"scylla|el_GR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"el"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"GR"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"scylla|hr_HR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|de_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|fr_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"fr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|it_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|hr_HR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>type SiteString = keyof </span><span style=color:#8fbcbb>SiteOfString</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type _2 = </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#a3be8c>"scylla|hr_HR"</span><span>]</span><span style=color:#eceff4>; </span><span style=color:#616e88>// S&lt;"scylla", "hr", "HR">
</span></code></pre><p>Once again we can derive the union we wrote above from this table to save us a bit of typing. We still need to be very careful to keep <code>Site</code> and <code>SiteOfString</code> in sync, because debugging a type error deriving from one of those could easily get confusing.<p>Now let us implement the function to parse a <code>SiteString</code> into a <code>Site</code>.<p><strong>Content warning: unsafe type assertions</strong><pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>export const </span><span style=color:#88c0d0;font-weight:700>parseSiteString </span><span style=color:#81a1c1>= </span><span>&lt;</span><span style=color:#8fbcbb>SS </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>SiteString</span><span>>(
</span><span>  siteString</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SS
</span><span>)</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>SS</span><span>] </span><span style=color:#81a1c1>=> </span><span>{
</span><span>  </span><span style=color:#81a1c1>const </span><span>[</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>name</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>language</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>country</span><span>] </span><span style=color:#81a1c1>= </span><span>siteString</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span>(
</span><span>    </span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>(</span><span>[a-z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)\|(</span><span>[a-z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)_(</span><span>[A-Z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)</span><span style=color:#a3be8c>/
</span><span>  )</span><span style=color:#81a1c1>! as any</span><span>[]</span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#81a1c1>return </span><span>{ name</span><span style=color:#eceff4>, </span><span>language</span><span style=color:#eceff4>, </span><span>country }</span><span style=color:#eceff4>;
</span><span>}</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#88c0d0>parseSiteString</span><span>(</span><span style=color:#a3be8c>"scylla|hr_HR"</span><span>)</span><span style=color:#eceff4>; </span><span style=color:#616e88>// S&lt;"scylla", "hr", "HR">
</span></code></pre><p>The two assertions make us sick to the stomach, but after adding a few tests we feel better enough to move onwards. Seeing the function convert the string with 0 type information loss really is its own reward.<p>The reverse is a bit trickier, but fortunately the very nice <a rel="nofollow noreferrer" class=external-link href=https://github.com/gcanti/typelevel-ts>typelevel-ts</a> library already has a similar type we can look up to help us on our journey to enlightenment, namely <code>KeysOfType</code>.<blockquote><p><code>KeysOfType</code>: Picks only the keys of a certain type</blockquote><pre style=color:#d8dee9;background-color:#2e3440><code><span>export type KeysOfType&lt;A extends object, B> = { [K in keyof A]-?: A[K] extends B ? K : never }[keyof A]
</span></code></pre><p>Let us adapt it for our use case.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>export type StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Site</span><span>> </span><span style=color:#81a1c1>= </span><span>{
</span><span>  [</span><span style=color:#8fbcbb>K </span><span style=color:#81a1c1>in </span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"name"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"name"</span><span>] </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>K </span><span style=color:#81a1c1>: never
</span><span>}[</span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type _3 = </span><span style=color:#8fbcbb>StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>>></span><span style=color:#eceff4>;
</span><span style=color:#616e88>// "scylla|it_IT" | "scylla|el_GR" | "scylla|hr_HR"
</span></code></pre><p>But that only returns the <code>SiteString</code>s with the same name, we hear a voice crying behind us. Patience, Homer. Design is an iterative process, and so let us iterate on the result of this first type with the other two parameters.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>export type StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Site</span><span>> </span><span style=color:#81a1c1>= </span><span>{
</span><span>  [</span><span style=color:#8fbcbb>K </span><span style=color:#81a1c1>in </span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"name"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"name"</span><span>]
</span><span>    </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"language"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"language"</span><span>]
</span><span>      </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"country"</span><span>]
</span><span>        </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>K
</span><span>        </span><span style=color:#81a1c1>: never
</span><span>      </span><span style=color:#81a1c1>: never
</span><span>    </span><span style=color:#81a1c1>: never
</span><span>}[</span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>export const </span><span style=color:#88c0d0;font-weight:700>serializeSite </span><span style=color:#81a1c1>= </span><span>&lt;</span><span style=color:#8fbcbb>S </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Site</span><span>>({
</span><span>  name</span><span style=color:#eceff4>,
</span><span>  language</span><span style=color:#eceff4>,
</span><span>  country
</span><span>}</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>) </span><span style=color:#81a1c1>=> </span><span style=color:#a3be8c>`</span><span style=color:#5e81ac>${</span><span>name</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>|</span><span style=color:#5e81ac>${</span><span>language</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>_</span><span style=color:#5e81ac>${</span><span>country</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>` </span><span style=color:#81a1c1>as </span><span style=color:#8fbcbb>StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S</span><span>></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#88c0d0>serializeSite</span><span>({ name</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span>language</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span>country</span><span style=color:#eceff4>: </span><span style=color:#a3be8c>"CH" </span><span>})</span><span style=color:#eceff4>;
</span><span style=color:#616e88>// "charybdis|de_CH"
</span></code></pre><p>That'll do, pig. That'll do.<hr><p>You probably shouldn't use this kind of type-level hackery on a production application. But you might get away with it if you use a type-level testing library like <a rel="nofollow noreferrer" class=external-link href=https://github.com/Microsoft/dtslint>dtslint</a> or <a rel="nofollow noreferrer" class=external-link href=https://github.com/dsherret/conditional-type-checks>conditional-type-checks</a>.<p>Here's the full source code, ready to be pasted in your editor or on <a rel="nofollow noreferrer" class=external-link href=https://www.typescriptlang.org/play/index.html>TypeScript's playground</a>.<pre class=language-typescript data-lang=typescript style=color:#d8dee9;background-color:#2e3440><code class=language-typescript data-lang=typescript><span style=color:#81a1c1>interface S</span><span>&lt;</span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>, </span><span style=color:#8fbcbb>Country</span><span>> {
</span><span>  name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteName</span><span style=color:#eceff4>;
</span><span>  language</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Language</span><span style=color:#eceff4>;
</span><span>  country</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>Country</span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>type Site =
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"IT"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"el"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"GR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"fr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>>
</span><span>  </span><span style=color:#81a1c1>| </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type SiteName = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"name"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Language = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"language"</span><span>]</span><span style=color:#eceff4>;
</span><span style=color:#81a1c1>type Country = </span><span style=color:#8fbcbb>Site</span><span>[</span><span style=color:#a3be8c>"country"</span><span>]</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>type SitesByName</span><span>&lt;</span><span style=color:#8fbcbb>N </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>SiteName</span><span>> </span><span style=color:#81a1c1>= </span><span style=color:#8fbcbb>Extract</span><span>&lt;</span><span style=color:#8fbcbb>Site</span><span style=color:#eceff4>, </span><span>{ name</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>N </span><span>}></span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>interface SiteOfString </span><span>{
</span><span>  </span><span style=color:#a3be8c>"scylla|it_IT"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"IT"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"scylla|el_GR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"el"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"GR"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"scylla|hr_HR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"scylla"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|de_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"de"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|fr_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"fr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|it_CH"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"it"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"CH"</span><span>></span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#a3be8c>"charybdis|hr_HR"</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>&lt;</span><span style=color:#a3be8c>"charybdis"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"hr"</span><span style=color:#eceff4>, </span><span style=color:#a3be8c>"HR"</span><span>></span><span style=color:#eceff4>;
</span><span>}
</span><span>
</span><span style=color:#81a1c1>type SiteString = keyof </span><span style=color:#8fbcbb>SiteOfString</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>export const </span><span style=color:#88c0d0;font-weight:700>parseSiteString </span><span style=color:#81a1c1>= </span><span>&lt;</span><span style=color:#8fbcbb>SS </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>SiteString</span><span>>(
</span><span>  siteString</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SS
</span><span>)</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>SS</span><span>] </span><span style=color:#81a1c1>=> </span><span>{
</span><span>  </span><span style=color:#81a1c1>const </span><span>[</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>name</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>language</span><span style=color:#eceff4>, </span><span style=color:#d8dee9;font-weight:700>country</span><span>] </span><span style=color:#81a1c1>= </span><span>siteString</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>match</span><span>(
</span><span>    </span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>(</span><span>[a-z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)\|(</span><span>[a-z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)_(</span><span>[A-Z]</span><span style=color:#81a1c1>+</span><span style=color:#ebcb8b>)</span><span style=color:#a3be8c>/
</span><span>  )</span><span style=color:#81a1c1>! as any</span><span>[]</span><span style=color:#eceff4>;
</span><span>  </span><span style=color:#81a1c1>return </span><span>{ name</span><span style=color:#eceff4>, </span><span>language</span><span style=color:#eceff4>, </span><span>country }</span><span style=color:#eceff4>;
</span><span>}</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>export type StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Site</span><span>> </span><span style=color:#81a1c1>= </span><span>{
</span><span>  [</span><span style=color:#8fbcbb>K </span><span style=color:#81a1c1>in </span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"name"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"name"</span><span>]
</span><span>    </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"language"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"language"</span><span>]
</span><span>      </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>SiteOfString</span><span>[</span><span style=color:#8fbcbb>K</span><span>][</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>S</span><span>[</span><span style=color:#a3be8c>"country"</span><span>] </span><span style=color:#81a1c1>? </span><span style=color:#8fbcbb>K </span><span style=color:#81a1c1>: never
</span><span>      </span><span style=color:#81a1c1>: never
</span><span>    </span><span style=color:#81a1c1>: never
</span><span>}[</span><span style=color:#8fbcbb>SiteString</span><span>]</span><span style=color:#eceff4>;
</span><span>
</span><span style=color:#81a1c1>export const </span><span style=color:#88c0d0;font-weight:700>serializeSite </span><span style=color:#81a1c1>= </span><span>&lt;</span><span style=color:#8fbcbb>S </span><span style=color:#81a1c1>extends </span><span style=color:#8fbcbb>Site</span><span>>({
</span><span>  name</span><span style=color:#eceff4>,
</span><span>  language</span><span style=color:#eceff4>,
</span><span>  country
</span><span>}</span><span style=color:#81a1c1>: </span><span style=color:#8fbcbb>S</span><span>) </span><span style=color:#81a1c1>=> </span><span style=color:#a3be8c>`</span><span style=color:#5e81ac>${</span><span>name</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>|</span><span style=color:#5e81ac>${</span><span>language</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>_</span><span style=color:#5e81ac>${</span><span>country</span><span style=color:#5e81ac>}</span><span style=color:#a3be8c>` </span><span style=color:#81a1c1>as </span><span style=color:#8fbcbb>StringOfSite</span><span>&lt;</span><span style=color:#8fbcbb>S</span><span>></span><span style=color:#eceff4>;
</span></code></pre></div></article></main><footer class=main><a class=logo href=/> <svg viewbox="0 0 79 49" version=1.1 xmlns=http://www.w3.org/2000/svg xmlns:svg=http://www.w3.org/2000/svg><title>Steen's online burrow</title><g fill=currentColor><g><path d="M 17,7 V 9 H 15 V 8 h -1 v 3 h 1 v 1 h 2 v 1 h 4 V 9 H 20 V 8 H 19 V 5 h 1 V 4 h 1 V 3 h 4 v 1 h -3 v 3 h 1 v 1 h 1 v 4 h -1 v 1 h -1 c 0,0 0,1 0,1 H 16 V 13 H 13 V 12 10 H 12 V 8 h 1 V 7 Z"/><path d="m 30,5 v 1 h 2 V 5 h 3 v 1 h -2 v 1 h -2 v 4 h -1 v 1 h -1 v 1 h -1 c 0,0 0,2 0,2 h -1 c 0,0 0,1 0,1 h -1 v -3 h 1 v -2 h 1 V 7 H 26 V 6 H 24 V 5 Z"/><path d="m 39,5 v 2 h -1 c 0,0 0,1 0,1 h -1 c 0,0 0,1 0,1 h -2 v 1 h 4 c 0,0 0,2 0,2 h -2 v -1 h -3 v 1 h -1 v 2 h 2 v -1 h 3 v 1 h 1 v 1 h 1 c 0,0 0,1 0,1 h -2 v -1 h -4 c 0,0 0,1 0,1 h -4 v -1 h 1 v -2 h 1 v -2 h 1 V 8 h 3 V 7 h 1 V 6 h 1 V 5 Z"/><path d="m 42,5 v 1 h 1 v 1 h 1 v 1 h 1 v 1 h 2 v 1 H 44 V 9 h -1 v 2 h 3 v 1 h -2 v 1 h -1 v 1 h 2 v -1 h 2 v 2 h -4 c 0,0 0,1 0,1 h -2 v -2 h 1 V 9 H 41 V 7 H 40 V 5 Z"/><path d="m 48,6 v 2 h 1 v 4 h 1 c 0,0 0,2 0,2 h -1 v 3 c 0,0 1,0 1,0 v -1 h 1 v -2 h 1 v -2 h 1 v 1 h 1 v 1 h 1 v 1 h 2 V 14 H 56 V 9 h 1 V 7 h 1 V 5 h 1 V 4 h 1 V 2 h -1 v 1 h -2 v 1 h -1 v 4 h -1 v 4 H 54 V 11 H 53 V 10 H 51 V 8 H 50 V 7 H 49 V 6 Z"/><path d="m 61,0 v 1 h 1 v 3 h 2 V 2 H 63 V 0 Z"/><path d="m 67,4 v 1 h -1 v 2 h 1 c 0,0 0,3 0,3 h -1 v 1 c 0,0 -4,0 -4,0 v -1 h 2 V 9 h 1 V 8 H 64 V 5 h 1 V 4 Z"/></g><g><path d="m 26,22 h 3 v -1 h -3 z"/><path d="m 31,20 v 1 h 1 v 1 h 1 v -2 z m 1,2 h -1 v -1 h -1 v 2 h 2 z"/><path d="m 34,20 v 3 h 1 v -2 h 1 v 2 h 1 v -2 h -1 v -1 z"/><path d="m 38,19 v 4 h 1 v -4 z"/><path d="m 40,19 v 1 h 1 v -1 z"/><path d="m 40,21 v 2 h 1 v -2 z"/><path d="m 42,23 v -3 h 2 v 1 h 1 c 0,0 0,2 0,2 h -1 v -2 h -1 v 2 z"/><path d="m 46,21 v 2 h 1 v 1 h 1 v -1 h -1 v -2 h 1 v 1 h 1 v -2 h -2 v 1 z"/><path d="m 50,21 c 0,0 0,1 0,1 h 3 v -1 z"/></g><g><path d="m 5,26 v 1 H 4 v 6 H 3 v 7 H 2 v 4 H 1 v 2 H 0 v 3 h 6 v -1 h 2 v -1 h 2 v -1 h 2 v -1 h 2 v -4 h -1 v -1 h -1 v -2 h 1 v -2 h 1 v -1 h 1 v -1 h 1 V 28 H 12 V 27 H 9 v -1 z m 2,4 h 2 v 1 h 3 v 2 h -1 v 1 h -1 v 1 H 9 v 1 H 8 v 1 H 6 V 36 H 7 Z M 6,41 h 2 v 1 h 2 v 1 H 8 v 1 H 6 v 1 H 5 v -2 h 1 z"/><path d="m 17,26 v 3 h 1 v 2 h -1 v 5 h -1 v 4 h -1 v 4 h 1 v 2 h 9 v -1 h 1 v -3 h 1 V 25 h -4 v 5 h 1 v 9 h -1 v 3 h -1 v 1 h -3 v -4 h 1 v -5 h 1 v -8 z"/><path d="m 28,27 v 5 h 1 v 2 h -1 v 14 h 3 V 38 h 1 v 4 h 1 v 4 h 1 v 2 h 3 v -5 h -1 v -4 h -1 v -5 h 3 v -6 h -2 v -1 z m 4,3 h 1 v 1 h -1 z"/><path d="m 40,27 v 21 h 3 V 37 h 1 v 1 h 1 v 1 h 1 v 1 h 1 v 2 h 1 v 1 h 1 v 2 h 4 v -3 h -1 v -1 h -1 v -2 h -1 v -1 h -1 v -1 h -1 v -9 h -2 v -1 z m 3,4 h 2 v 1 h -1 v 1 h -1 z"/><path d="m 52,27 v 1 h -1 v 1 h -1 v 7 h 1 v 1 h 1 v 1 h 1 v 1 h 5 v -1 h 2 v -1 h 1 v -8 h -1 v -1 h -4 v -1 z m 2,4 h 3 v 1 h 1 v 2 h -1 v 1 h -2 v -1 h -1 v -1 h -1 v -1 h 1 z"/><path d="m 63,25 v 4 h 1 v 16 h 4 v -1 h 1 v -1 h 1 v -2 h 2 v 1 h 2 v 1 h 1 v 1 h 4 v -5 h -1 v -3 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -2 h -1 v -3 h -1 v -1 h -3 v 4 h 1 v 3 h 1 v 2 h 1 v 2 h 1 v 2 h 1 v 1 h -1 v -1 h -4 v 1 H 67 V 26 h -1 v -1 z"/></g></g></svg> </a><div class=blurb>There is no end though there is a start in the past — Infinity.<br> It speaks, it ruins, and it goes though it consumes the soul — Finite.<br> Only the person who has wisdom can read the most foolish one from the history.<br> The daemon that lives in the machine doesn't understand the daemon that lives in the brain.<br> It is funnier that man exceeds the speed of light than machine start writing on a net.<br> It can be said that this is final ultimatum from the people who can think.</div></footer></div>